<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>منصة مفقودات السودان الشاملة 2026</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg: #f2f5f8; --accent: #27ae60; --danger: #e74c3c; --warning: #f39c12; --text: #2c3e50; --text-dim: #7f8c8d;
            --shadow: 8px 8px 16px #d1d9e6, -8px -8px 16px #ffffff;
            --inner-shadow: inset 6px 6px 12px #d1d9e6, inset -6px -6px 12px #ffffff;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); color: var(--text); margin: 0; direction: rtl; }
        
        .page { display: none; padding: 20px 15px 120px; min-height: 100vh; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: var(--bg); padding: 20px; border-radius: 25px; box-shadow: var(--shadow); margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.5); }
        .btn-submit { width: 100%; padding: 16px; border-radius: 18px; border: none; background: var(--bg); box-shadow: var(--shadow); color: var(--accent); font-weight: 800; cursor: pointer; margin-top: 12px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        
        .report-card { background: var(--bg); padding: 12px; border-radius: 22px; box-shadow: var(--shadow); display: flex; gap: 15px; margin-bottom: 15px; cursor: pointer; align-items: center; }
        .report-card img { width: 80px; height: 80px; border-radius: 18px; object-fit: cover; }
        
        .badge { padding: 4px 12px; border-radius: 10px; font-size: 11px; font-weight: bold; }
        .badge-lost { background: #ffdada; color: #c0392b; }
        .badge-found { background: #d4f8e2; color: #27ae60; }

        .match-box { background: #fff9e6; border: 2px dashed var(--warning); border-radius: 20px; padding: 15px; margin: 15px 0; }

        /* الدردشة */
        #chat-messages { height: calc(100vh - 250px); overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 12px 16px; border-radius: 18px; max-width: 80%; font-size: 14px; box-shadow: var(--shadow); }
        .msg.me { align-self: flex-start; background: var(--accent); color: white; border-bottom-right-radius: 4px; }
        .msg.them { align-self: flex-end; background: white; border-bottom-left-radius: 4px; }

        .bottom-nav { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 500px; height: 70px; background: rgba(242, 245, 248, 0.95); backdrop-filter: blur(10px); border-radius: 35px; display: flex; justify-content: space-around; align-items: center; box-shadow: var(--shadow); z-index: 1000; }
        .nav-item { color: var(--text-dim); text-align: center; font-size: 10px; flex: 1; cursor: pointer; position: relative; }
        .nav-item.active { color: var(--accent); }
        .notification-dot { position: absolute; top: 10px; right: 25%; width: 10px; height: 10px; background: var(--danger); border-radius: 50%; display: none; border: 2px solid var(--bg); }

        input, textarea { width: 100%; padding: 15px; border-radius: 15px; border: none; box-shadow: var(--inner-shadow); background: var(--bg); margin-bottom: 15px; outline: none; }
    </style>
</head>
<body>

    <main>
        <section id="pg-home" class="page active">
            <h2 style="padding:0 10px;">الرئيسية</h2>
            <input type="text" placeholder="بحث (ماركة، رقم شاسي، مكان...)" oninput="filterFeed(this.value)">
            <div id="home-feed"></div>
        </section>

        <section id="pg-details" class="page">
            <div id="details-content"></div>
        </section>

        <section id="pg-inbox" class="page">
            <h2>المحادثات</h2>
            <div id="inbox-list"></div>
        </section>

        <section id="pg-chat-view" class="page">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                <i class="fas fa-arrow-right" onclick="navigate('pg-inbox')"></i>
                <h4 id="active-chat-name" style="margin:0">دردشة</h4>
            </div>
            <div id="chat-messages"></div>
            <div style="display:flex; gap:10px; background:white; padding:10px; border-radius:20px; box-shadow:var(--shadow);">
                <input type="text" id="chat-input" placeholder="اكتب رسالتك..." style="margin-bottom:0; box-shadow:none;">
                <button onclick="sendMessage()" class="btn-submit" style="width:60px; margin-top:0; background:var(--accent); color:white;"><i class="fas fa-paper-plane"></i></button>
            </div>
        </section>

        <section id="pg-form" class="page">
            <h2>إضافة بلاغ</h2>
            <div class="card" style="text-align:center; cursor:pointer;" onclick="document.getElementById('file-input').click()">
                <img id="img-preview" style="width:100%; height:150px; object-fit:contain; display:none">
                <div id="up-placeholder"><i class="fas fa-camera" style="font-size:40px;"></i><br>ارفق صورة</div>
                <input type="file" id="file-input" hidden onchange="previewImg(event)">
            </div>
            <div style="display:flex; gap:10px;">
                <button id="btn-lost" onclick="setT('lost')" class="btn-submit" style="background:var(--danger); color:white;">مفقود</button>
                <button id="btn-found" onclick="setT('found')" class="btn-submit">موجود</button>
            </div>
            <input type="text" id="in-title" placeholder="العنوان">
            <textarea id="in-desc" rows="3" placeholder="الوصف التفصيلي (رقم الشاسي أو أي علامات)"></textarea>
            <input type="number" id="in-pin" placeholder="رمز الحذف PIN (4 أرقام)">
            <button class="btn-submit" style="background:var(--accent); color:white;" onclick="publish()">نشر الآن</button>
        </section>

        <section id="pg-legal" class="page">
            <div class="card">
                <h3><i class="fas fa-gavel"></i> اتفاقية الاستخدام</h3>
                <p style="font-size:13px; line-height:1.8;">
                    1. المستخدم مسؤول قانونياً عن صحة بلاغه.<br>
                    2. يمنع دفع أي مبالغ مالية قبل استلام الغرض يدوياً.<br>
                    3. المنصة غير مسؤولة عن أي احتيال يقع خارج إطارها التقني.
                </p>
                <button class="btn-submit" onclick="navigate('pg-home')">أوافق</button>
            </div>
        </section>
    </main>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="navigate('pg-home', this)"><i class="fas fa-home"></i><br>الرئيسية</div>
        <div class="nav-item" onclick="navigate('pg-inbox', this)">
            <div id="notif-dot" class="notification-dot"></div>
            <i class="fas fa-envelope"></i><br>الرسائل
        </div>
        <div class="nav-item" onclick="navigate('pg-form')" style="margin-top:-30px;"><div style="width:50px; height:50px; background:var(--accent); color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 5px 15px rgba(0,0,0,0.2)"><i class="fas fa-plus"></i></div></div>
        <div class="nav-item" onclick="navigate('pg-legal', this)"><i class="fas fa-shield-alt"></i><br>قانوني</div>
        <div class="nav-item" onclick="logout()"><i class="fas fa-sign-out-alt"></i><br>خروج</div>
    </nav>

    <div id="onboarding" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:9999; align-items:center; justify-content:center; padding:20px;">
        <div class="card" style="width:100%;">
            <h3 style="text-align:center">تسجيل البيانات</h3>
            <input type="text" id="reg-name" placeholder="الاسم الرباعي">
            <input type="tel" id="reg-phone" placeholder="رقم الهاتف">
            <button class="btn-submit" onclick="saveUser()">دخول</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCybHxby_BWoisXHKg5PYEzNgRosBvH66Y",
            authDomain: "mafgoodsudan-b76ab.firebaseapp.com",
            databaseURL: "https://mafgoodsudan-b76ab-default-rtdb.firebaseio.com",
            projectId: "mafgoodsudan-b76ab",
            storageBucket: "mafgoodsudan-b76ab.appspot.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let allReports = [];
        let curT = 'lost';
        let curImg = "";
        let curRoom = "";

        // نظام التنقل
        function navigate(id, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(el) {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                el.classList.add('active');
            }
            if(id === 'pg-inbox') { 
                document.getElementById('notif-dot').style.display = 'none'; 
                loadInbox();
            }
        }

        // تحميل البيانات والمطابقة والبحث
        function loadData() {
            db.ref('reports').on('value', snap => {
                allReports = [];
                snap.forEach(c => allReports.push({id: c.key, ...c.val()}));
                render(allReports.slice().reverse());
            });
        }

        function render(data) {
            let h = "";
            data.forEach(item => {
                h += `<div class="report-card" onclick="showDet('${item.id}')">
                    <img src="${item.img || 'https://via.placeholder.com/80'}">
                    <div style="flex:1">
                        <h4 style="margin:0">${item.title}</h4>
                        <span class="badge ${item.type==='lost'?'badge-lost':'badge-found'}">${item.type==='lost'?'مفقود':'موجود'}</span>
                    </div>
                </div>`;
            });
            document.getElementById('home-feed').innerHTML = h;
        }

        function showDet(id) {
            const item = allReports.find(r => r.id === id);
            const user = JSON.parse(localStorage.getItem('sudan_user_data'));
            
            // المطابقة الذكية في الحقلين
            const txt = (item.title + " " + item.desc).toLowerCase();
            const keys = txt.split(/\s+/).filter(k => k.length > 3);
            const matches = allReports.filter(r => r.type !== item.type && keys.some(k => (r.title + " " + r.desc).toLowerCase().includes(k)));

            let mH = matches.length > 0 ? `<div class="match-box"><h4><i class="fas fa-magic"></i> مطابقات ذكية (${matches.length})</h4>` + 
                matches.map(m => `<div onclick="event.stopPropagation(); showDet('${m.id}')" style="color:blue; margin-bottom:5px;">• ${m.title}</div>`).join('') + `</div>` : "";

            document.getElementById('details-content').innerHTML = `
                <i class="fas fa-arrow-right" onclick="navigate('pg-home')"></i>
                <div class="card" style="margin-top:10px; padding:0; overflow:hidden;"><img src="${item.img}" style="width:100%;"></div>
                <div class="card">
                    <h3>${item.title}</h3>
                    <p>${item.desc}</p>
                    ${mH}
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <button onclick="window.location.href='tel:${item.phone}'" class="btn-submit" style="background:var(--accent); color:white;">اتصال</button>
                    <button onclick="startChat('${item.id}')" class="btn-submit">دردشة</button>
                </div>
                <button onclick="delReport('${item.id}')" style="width:100%; border:none; background:none; margin-top:20px; font-size:11px;">حذف بلاغي</button>
            `;
            navigate('pg-details');
        }

        // نظام الدردشة والإشعارات
        function startChat(id) {
            const item = allReports.find(r => r.id === id);
            const user = JSON.parse(localStorage.getItem('sudan_user_data'));
            if(user.phone === item.phone) return alert("بلاغك الخاص");
            
            const room = [user.phone, item.phone].sort().join("_");
            curRoom = room;
            document.getElementById('active-chat-name').innerText = item.title;
            navigate('pg-chat-view');
            
            db.ref('chats/' + room).on('value', snap => {
                let h = "";
                snap.forEach(m => {
                    const msg = m.val();
                    h += `<div class="msg ${msg.s === user.phone ? 'me' : 'them'}">${msg.t}</div>`;
                });
                const div = document.getElementById('chat-messages');
                div.innerHTML = h;
                div.scrollTop = div.scrollHeight;
            });
        }

        function sendMessage() {
            const t = document.getElementById('chat-input').value;
            const user = JSON.parse(localStorage.getItem('sudan_user_data'));
            if(!t) return;
            db.ref('chats/' + curRoom).push({ s: user.phone, t: t, time: Date.now() });
            document.getElementById('chat-input').value = "";
        }

        function loadInbox() {
            const user = JSON.parse(localStorage.getItem('sudan_user_data'));
            db.ref('chats').on('value', snap => {
                let h = "";
                snap.forEach(room => {
                    if(room.key.includes(user.phone)) {
                        const msgs = Object.values(room.val());
                        const last = msgs[msgs.length-1];
                        h += `<div class="report-card" onclick="curRoom='${room.key}'; navigate('pg-chat-view');">
                            <div style="flex:1"><h4>محادثة: ${room.key.replace(user.phone, "").replace("_","")}</h4><p style="font-size:12px;">${last.t}</p></div>
                        </div>`;
                    }
                });
                document.getElementById('inbox-list').innerHTML = h || "لا توجد رسائل";
            });
        }

        // مراقب الرسائل الجديدة للإشعارات
        function watchNewMessages() {
            const user = JSON.parse(localStorage.getItem('sudan_user_data'));
            if(!user) return;
            db.ref('chats').on('child_changed', snap => {
                if(snap.key.includes(user.phone)) {
                    const msgs = Object.values(snap.val());
                    if(msgs[msgs.length-1].s !== user.phone) {
                        document.getElementById('notif-dot').style.display = 'block';
                    }
                }
            });
        }

        // وظائف النشر والحذف
        function publish() {
            const user = JSON.parse(localStorage.getItem('sudan_user_data'));
            const title = document.getElementById('in-title').value;
            const desc = document.getElementById('in-desc').value;
            const pin = document.getElementById('in-pin').value;
            if(!title || !desc || pin.length < 4) return alert("أكمل البيانات");
            
            db.ref('reports').push({ title, desc, pin, phone: user.phone, type: curT, img: curImg, timestamp: Date.now() })
            .then(() => { alert("تم النشر"); location.reload(); });
        }

        function delReport(id) {
            const item = allReports.find(r => r.id === id);
            const user = JSON.parse(localStorage.getItem('sudan_user_data'));
            if(user.phone !== item.phone) return alert("ليس بلاغك");
            const p = prompt("PIN:");
            if(p === item.pin) db.ref('reports').child(id).remove().then(() => navigate('pg-home'));
        }

        function previewImg(e) {
            const reader = new FileReader();
            reader.onload = () => {
                curImg = reader.result;
                document.getElementById('img-preview').src = curImg;
                document.getElementById('img-preview').style.display = 'block';
                document.getElementById('up-placeholder').style.display = 'none';
            };
            reader.readAsDataURL(e.target.files[0]);
        }

        function setT(t) {
            curT = t;
            document.getElementById('btn-lost').style.background = t==='lost'?'var(--danger)':'var(--bg)';
            document.getElementById('btn-found').style.background = t==='found'?'var(--accent)':'var(--bg)';
        }

        function saveUser() {
            const n = document.getElementById('reg-name').value;
            const p = document.getElementById('reg-phone').value;
            if(n.length < 5 || p.length < 10) return alert("بيانات ناقصة");
            localStorage.setItem('sudan_user_data', JSON.stringify({name:n, phone:p}));
            location.reload();
        }

        function filterFeed(v) {
            const term = v.toLowerCase();
            render(allReports.filter(r => r.title.toLowerCase().includes(term) || r.desc.toLowerCase().includes(term)));
        }

        function logout() { localStorage.clear(); location.reload(); }

        window.onload = () => {
            if(!localStorage.getItem('sudan_user_data')) document.getElementById('onboarding').style.display = 'flex';
            else { loadData(); watchNewMessages(); }
        };
    </script>
</body>
</html>
