<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>مفقودات السودان - النسخة الرسمية 2026</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg: #f2f5f8; --accent: #27ae60; --danger: #e74c3c; --warning: #f1c40f; --text: #2c3e50; --text-dim: #7f8c8d;
            --shadow: 8px 8px 16px #d1d9e6, -8px -8px 16px #ffffff;
            --inner-shadow: inset 6px 6px 12px #d1d9e6, inset -6px -6px 12px #ffffff;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); color: var(--text); margin: 0; direction: rtl; overflow-x: hidden; }
        
        .page { display: none; padding: 20px 15px 120px; min-height: 100vh; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: var(--bg); padding: 20px; border-radius: 25px; box-shadow: var(--shadow); margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.5); }
        .btn-submit { width: 100%; padding: 16px; border-radius: 18px; border: none; background: var(--bg); box-shadow: var(--shadow); color: var(--accent); font-weight: 800; cursor: pointer; margin-top: 12px; font-size: 15px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-submit:active { box-shadow: var(--inner-shadow); transform: scale(0.98); }
        
        .report-card { background: var(--bg); padding: 12px; border-radius: 22px; box-shadow: var(--shadow); display: flex; gap: 15px; margin-bottom: 15px; cursor: pointer; }
        .report-card img { width: 85px; height: 85px; border-radius: 18px; object-fit: cover; box-shadow: 2px 2px 5px rgba(0,0,0,0.05); }
        
        .badge { padding: 4px 12px; border-radius: 10px; font-size: 11px; font-weight: bold; }
        .badge-lost { background: #ffdada; color: #c0392b; }
        .badge-found { background: #d4f8e2; color: #27ae60; }

        .bottom-nav { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 480px; height: 70px; background: rgba(242, 245, 248, 0.95); backdrop-filter: blur(15px); border-radius: 35px; display: flex; justify-content: space-around; align-items: center; box-shadow: var(--shadow); z-index: 1000; border: 1px solid #fff; }
        .nav-item { color: var(--text-dim); text-align: center; font-size: 10px; flex: 1; cursor: pointer; transition: 0.3s; }
        .nav-item.active { color: var(--accent); }
        .plus-center { width: 55px; height: 55px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white !important; margin-top: -40px; border: 4px solid var(--bg); font-size: 22px; box-shadow: 0 8px 15px rgba(39, 174, 96, 0.3); }

        /* Chat Styles */
        #chat-messages {
    height: calc(100vh - 250px); /* يضبط الطول تلقائياً حسب الشاشة */
    overflow-y: auto;
    padding: 15px;
    display: flex;
    flex-direction: column;
}

        .msg { padding: 12px 16px; border-radius: 18px; max-width: 85%; font-size: 14px; box-shadow: var(--shadow); line-height: 1.5; }
        .msg.me { align-self: flex-start; background: var(--accent); color: white; border-bottom-right-radius: 4px; }
        .msg.them { align-self: flex-end; background: white; color: var(--text); border-bottom-left-radius: 4px; }

        #splash { position: fixed; inset: 0; background: var(--bg); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .legal-notice { font-size: 11px; color: var(--danger); font-weight: bold; background: #fff1f1; padding: 10px; border-radius: 12px; margin-top: 10px; border: 1px dashed var(--danger); }
    </style>
</head>
<body>

    <div id="splash">
        <i class="fas fa-gavel" style="font-size: 60px; color: var(--accent);"></i>
        <h2 style="margin-top: 20px;">مفقودات السودان 2026<br><span style="font-size: 14px; color: var(--text-dim);">المنصة الرسمية الموحدة</span></h2>
        <p style="font-size: 10px; position: absolute; bottom: 30px;">بالتعاون مع الجهات العدلية - إدارة المباحث الجنائية</p>
    </div>

    <div id="onboarding" class="modal-overlay" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 9000; display: flex; align-items: center; justify-content: center; padding: 20px;">
        <div class="card" style="max-width: 400px; width: 100%;">
            <h3 style="text-align:center">تسجيل الدخول الآمن</h3>
            <p style="font-size: 12px; text-align: center; color: var(--text-dim);">يتم تسجيل رقم الهاتف كمرجع قانوني للبلاغات</p>
            <input type="text" id="user-name-init" placeholder="الاسم الرباعي كما في الهوية" style="width:100%; padding:15px; border-radius:15px; border:none; box-shadow:var(--inner-shadow); background:var(--bg); margin-bottom:15px;">
            <input type="tel" id="user-phone-init" placeholder="رقم الهاتف (0xxxxxxxxx)" style="width:100%; padding:15px; border-radius:15px; border:none; box-shadow:var(--inner-shadow); background:var(--bg);">
            <button class="btn-submit" onclick="saveUserData()">موافقة ودخول</button>
        </div>
    </div>

    <main id="main-app">
        <section id="pg-home" class="page active">
        <div class="stats-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
    <div class="stat-card" style="background: var(--bg); padding: 15px; border-radius: 20px; text-align: center; box-shadow: var(--inner-shadow);">
        <h2 id="count-lost" style="color: var(--danger); margin: 0;">0</h2>
        <span style="font-size: 12px; color: var(--text-dim);">بلاغات مفقودة</span>
    </div>
    <div class="stat-card" style="background: var(--bg); padding: 15px; border-radius: 20px; text-align: center; box-shadow: var(--inner-shadow);">
        <h2 id="count-found" style="color: var(--accent); margin: 0;">0</h2>
        <span style="font-size: 12px; color: var(--text-dim);">بلاغات موجودة</span>
    </div>
</div>

            <div class="search-wrapper" style="background:var(--bg); padding:15px; border-radius:50px; box-shadow:var(--inner-shadow); display:flex; align-items:center; gap:10px; margin-bottom:20px;">
                <i class="fas fa-search" style="color:var(--text-dim)"></i>
                <input type="text" placeholder="بحث في السجلات الرسمية..." style="border:none; background:transparent; width:100%;" oninput="filterFeed(this.value)">
            </div>
            <div id="home-feed"></div>
        </section>

        <section id="pg-details" class="page">
            <div id="details-view"></div>
        </section>

        <section id="pg-profile" class="page">
            <div class="card" style="text-align: center;">
                <h3 class="u-name">...</h3>
                <p id="u-phone-display" style="color:var(--text-dim);"></p>
                <div style="font-size: 10px; color: var(--accent); border: 1px solid var(--accent); padding: 5px; border-radius: 10px;">هوية موثقة رقمياً</div>
            </div>

            <button class="btn-submit" onclick="showMyReports()"><i class="fas fa-folder-open"></i> سجل بلاغاتي</button>
           <div class="nav-item" onclick="loadMyInbox(this)"> <i class="fas fa-comments"></i><br>الرسائل</div>

            <div class="card" style="margin-top: 25px; background: #fff;">
                <h4 style="margin: 0 0 10px 0; color: var(--danger);"><i class="fas fa-balance-scale"></i> التنبيه القانوني</h4>
                <p style="font-size: 12px; line-height: 1.6; margin: 0;">
                    بموجب قانون المعلوماتية، تخضع كافة البيانات المنشورة للرقابة. يتم تزويد <b>إدارة المباحث الجنائية</b> بنسخة دورية من البلاغات للتحقق من الأغراض المسروقة والمفقودة.
                </p>
                <button class="btn-submit" style="font-size: 12px; color: var(--text);" onclick="navigate('pg-legal')">عرض اتفاقية المسؤولية الكاملة</button>
            </div>

            <button class="btn-submit" style="color:var(--danger); box-shadow:none;" onclick="logout()">تسجيل الخروج</button>
        </section>

        <section id="pg-legal" class="page">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:20px"><i class="fas fa-arrow-right" onclick="navigate('pg-profile')"></i> <h2>المسؤولية القانونية</h2></div>
            <div class="card" style="font-size: 13px; line-height: 1.8;">
                <p><b>أولاً:</b> يقر المستخدم بأن كل معلومة يدلي بها هي تحت مسؤوليته الشخصية والجنائية.</p>
                <p><b>ثانياً:</b> المنصة مرتبطة بنظام أرشفة يسهل مراجعته من قبل الجهات العدلية في حالات البلاغات الكاذبة (المادة 97 من القانون الجنائي).</p>
                <p><b>ثالثاً:</b> يمنع منعاً باتاً نشر صور الأسلحة، العملات المزيفة، أو أي مواد محظورة قانوناً.</p>
                <p><b>رابعاً:</b> زر "التبليغ عن احتيال" يؤدي لمراجعة البلاغ وحظر رقم الناشر نهائياً وتعميمه كجهة غير موثوقة.</p>
            </div>
        </section>

        <section id="pg-form" class="page">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:20px"><i class="fas fa-arrow-right" onclick="navigate('pg-home')"></i> <h2>إضافة بلاغ رسمي</h2></div>
            <div class="card" style="height:220px; display:flex; align-items:center; justify-content:center; position:relative;" onclick="document.getElementById('file-input').click()">
                <img id="img-preview" style="width:100%; height:100%; object-fit:contain; display:none">
                <div id="upload-placeholder" style="text-align:center;"><i class="fas fa-camera-retro" style="font-size:40px; color:var(--accent)"></i><br>ارفق صورة الغرض</div>
                <input type="file" id="file-input" hidden onchange="handleImageSelection(event)">
            </div>
            <div class="legal-notice">إقرار: أتعهد بأن هذا البلاغ صحيح وأتحمل المسؤولية القانونية تجاهه.</div>
            <input type="text" id="inp-title" placeholder="عنوان البلاغ (مثال: حقيبة مستندات)" style="width:100%; padding:15px; margin-top:15px; border-radius:12px; border:none; box-shadow:var(--inner-shadow); background:var(--bg);">
            <textarea id="inp-desc" placeholder="وصف دقيق (المكان، الزمان، علامات مميزة)..." style="width:100%; padding:15px; height:120px; margin-top:15px; border-radius:12px; border:none; box-shadow:var(--inner-shadow); background:var(--bg);"></textarea>
            <input type="number" id="inp-pin" placeholder="رمز PIN للحماية (4 أرقام)" style="width:100%; padding:15px; margin-top:15px; border-radius:12px; border:none; box-shadow:var(--inner-shadow); background:var(--bg);">
            <div class="legal-disclaimer-box" style="background: #fff5f5; border: 1px solid #ffcccc; padding: 15px; border-radius: 15px; margin: 15px 0;">
    <h4 style="color: #c0392b; margin-top: 0; font-size: 14px;"><i class="fas fa-balance-scale"></i> إخلاء مسؤولية قانوني</h4>
    <p style="font-size: 11px; line-height: 1.5; color: #666; margin-bottom: 0;">
        بضغطك على "تأكيد ونشر"، تقر بأنك المالك الشرعي أو واجد الغرض، وتوافق على مشاركة موقعك ورقم هاتفك مع <b>إدارة المباحث الجنائية</b> في حال تم التبليغ عن هذا المنشور كبلاغ كاذب. المنصة غير مسؤولة عن أي تعاملات مالية تتم بين المستخدمين.
    </p>
</div>

            <button class="btn-submit" style="background:var(--accent); color:white;" onclick="publishReport()">تأكيد ونشر رسمي</button>
        </section>

<section id="pg-disclaimer" class="page">
    <div style="display:flex; align-items:center; gap:10px; margin-bottom:20px">
        <i class="fas fa-arrow-right" onclick="navigate('pg-profile')"></i> 
        <h2>اتفاقية الاستخدام وإخلاء المسؤولية</h2>
    </div>
    
    <div class="card" style="font-size: 13px; line-height: 1.8; text-align: justify;">
        <h4 style="color: var(--danger); text-align: center;">إقرار ومسؤولية قانونية</h4>
        <p><b>1. طبيعة المنصة:</b> هذه المنصة هي وسيط تقني لتسهيل العثور على المفقودات، وليست جهة تنفيذية. كافة البيانات المدخلة تعبر عن أصحابها.</p>
        
        <p><b>2. المسؤولية الجنائية:</b> يقر المستخدم بأن أي بلاغ كاذب أو تضليلي يعرضه للمساءلة تحت المادة (97) من القانون الجنائي السوداني "إعطاء معلومات كاذبة".</p>
        
        <p><b>3. الخصوصية والأمن:</b> يوافق المستخدم على مشاركة بيانات الاتصال الخاصة به (الهاتف، الاسم) مع الأطراف الأخرى لغرض استرداد المفقودات، وللجهات العدلية في حال طلبها رسمياً.</p>
        
        <p><b>4. المعاملات المالية:</b> تخلي إدارة التطبيق مسؤوليتها عن أي مكافآت مالية يتم الاتفاق عليها بين الأفراد، وتحذر من دفع أي مبالغ قبل معاينة الغرض المفقود واستلامه في مكان آمن.</p>
        
        <p><b>5. الرقابة:</b> للمسؤولين الحق في حذف أي بلاغ يحتوي على محتوى غير لائق أو يمس أمن الدولة أو ينتهك خصوصية الآخرين دون الرجوع للناشر.</p>
    </div>
    
    <button class="btn-submit" onclick="navigate('pg-home')" style="background: var(--accent); color: white;">أوافق على كافة الشروط</button>
</section>

        <section id="pg-chat" class="page">
            <div id="chat-header" style="display:flex; align-items:center; gap:15px; margin-bottom:15px;">
                <i class="fas fa-arrow-right" onclick="navigate('pg-home')"></i>
                <h4 id="chat-title" style="margin:0">الدردشة الآمنة</h4>
            </div>
            <div id="chat-messages"></div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <input type="text" id="chat-input" placeholder="اكتب رسالة..." style="flex:1; padding:15px; border-radius:12px; border:none; box-shadow:var(--inner-shadow); background:var(--bg);">
                <button onclick="sendMessage()" style="width:50px; border-radius:12px; border:none; background:var(--accent); color:white;"><i class="fas fa-paper-plane"></i></button>
            </div>
        </section>

        <section id="pg-my-list" class="page">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:20px"><i class="fas fa-arrow-right" onclick="navigate('pg-profile')"></i> <h2>سجلاتي</h2></div>
           <div id="my-list-container" style="padding: 10px;"></div>
        </section>
    </main>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="navigate('pg-home', this)"><i class="fas fa-home"></i><br>الرئيسية</div>
        <div class="nav-item" onclick="loadMyInbox()"><i class="fas fa-comments"></i><br>الدردشة</div>
        <div class="nav-item plus-center" onclick="openForm('lost')"><i class="fas fa-plus"></i></div>
        <div class="nav-item" onclick="navigate('pg-profile', this)"><i class="fas fa-shield-alt"></i><br>الأمان</div>
    </nav>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCybHxby_BWoisXHKg5PYEzNgRosBvH66Y",
            authDomain: "mafgoodsudan-b76ab.firebaseapp.com",
            databaseURL: "https://mafgoodsudan-b76ab-default-rtdb.firebaseio.com",
            projectId: "mafgoodsudan-b76ab",
            storageBucket: "mafgoodsudan-b76ab.appspot.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let allReports = [];
        let base64Image = "";
        let currentType = 'lost';
        let currentRoomId = null;

        function navigate(pageId, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            if(el) {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                el.classList.add('active');
            }
            window.scrollTo(0,0);
        }

        // --- جلب البيانات ---
        function loadData() {
    db.ref('reports').on('value', (snap) => {
        allReports = [];
        let lostCount = 0;
        let foundCount = 0;
        
        snap.forEach(child => { 
            const data = child.val();
            allReports.push({ id: child.key, ...data });
            
            // عد الإحصائيات
            if(data.type === 'lost') lostCount++;
            else if(data.type === 'found') foundCount++;
        });

        // تحديث الأرقام في الواجهة
        document.getElementById('count-lost').innerText = lostCount;
        document.getElementById('count-found').innerText = foundCount;
        
        allReports.reverse();
        renderFeed(allReports);
    });
}

function checkUser() {
    const user = localStorage.getItem('sudan_user_data');
    if (!user) {
        document.getElementById('onboarding').style.display = 'flex';
        return false;
    }
    return JSON.parse(user);
}

        function renderFeed(data) {
            let html = "";
            data.forEach(item => {
                html += `
                <div class="report-card" onclick="viewDetails('${item.id}')">
                    <img src="${item.img}">
                    <div style="flex:1">
                        <h4 style="margin:0 0 5px 0">${item.title}</h4>
                        <span class="badge ${item.type==='lost'?'badge-lost':'badge-found'}">${item.type==='lost'?'مفقود':'موجود'}</span>
                        <div style="font-size:10px; color:var(--text-dim); margin-top:5px;"><i class="fas fa-clock"></i> ${new Date(item.timestamp).toLocaleDateString('ar-EG')}</div>
                    </div>
                </div>`;
            });
            document.getElementById('home-feed').innerHTML = html || "<p style='text-align:center'>لا توجد بلاغات حالياً</p>";
        }

        // --- التفاصيل مع زر الإبلاغ عن احتيال ---
        function viewDetails(id) {
            const item = allReports.find(r => r.id === id);
            document.getElementById('details-view').innerHTML = `
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:20px"><i class="fas fa-arrow-right" onclick="navigate('pg-home')"></i> <h2>تفاصيل البلاغ</h2></div>
                <div class="card" style="padding:0; overflow:hidden;"><img src="${item.img}" style="width:100%; max-height:350px; object-fit:contain; background:#000"></div>
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center">
                        <span class="badge ${item.type==='lost'?'badge-lost':'badge-found'}">${item.type==='lost'?'مفقود':'موجود'}</span>
                        <button onclick="reportFraud('${id}')" style="background:none; border:none; color:var(--danger); font-size:11px; font-weight:bold;"><i class="fas fa-exclamation-triangle"></i> إبلاغ عن احتيال</button>
                    </div>
                    <h3 style="margin: 15px 0 10px;">${item.title}</h3>
                    <p style="user-select:text; font-size:14px; line-height:1.6;">${item.desc}</p>
                </div>
               <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px;">
    <button onclick="contactAction('tel', '${item.phone}')" class="btn-submit" style="background:var(--accent); color:white; font-size:12px;">
        <i class="fas fa-phone"></i> اتصال
    </button>
    
    <button onclick="contactAction('wa', '${item.phone}')" class="btn-submit" style="background:#25D366; color:white; font-size:12px;">
        <i class="fab fa-whatsapp"></i> واتساب
    </button>
    
    <button onclick="startChat('${id}')" class="btn-submit" style="background:var(--text); color:white; font-size:12px;">
        <i class="fas fa-comments"></i> دردشة
    </button>
</div>

                <button onclick="deleteReport('${id}')" style="width:100%; border:none; background:none; color:var(--text-dim); margin-top:30px; font-size:12px;">حذف بلاغي (يتطلب PIN)</button>
            `;
            navigate('pg-details');
        }

        // --- نظام الإبلاغ عن الاحتيال ---
        function reportFraud(reportId) {
            const reason = prompt("يرجى ذكر سبب التبليغ عن هذا البلاغ (بلاغ كاذب، صورة مسيئة، احتيال مالي):");
            if (reason) {
                db.ref('fraud_reports').push({
                    reportId: reportId,
                    reason: reason,
                    reporter: JSON.parse(localStorage.getItem('sudan_user_data')).phone,
                    timestamp: Date.now()
                }).then(() => {
                    alert("شكرًا لك. تم إرسال التقرير للإدارة وللجهات العدلية للمراجعة.");
                });
            }
        }

        // --- نظام الدردشة المحسن ---
       function startChat(reportId) {
    const item = allReports.find(r => r.id === reportId);
    const user = JSON.parse(localStorage.getItem('sudan_user_data'));
    
    if (!user) return alert("يرجى تسجيل بياناتك أولاً من صفحة الأمان");
    if (user.phone === item.phone) return alert("هذا بلاغك الخاص، لا يمكنك مراسلة نفسك.");

    // توحيد المعرف: ترتيب الأرقام لضمان الوصول لنفس الغرفة دائماً
    const ids = [user.phone, item.phone].sort();
    const roomId = `chat_${reportId}_${ids[0]}_${ids[1]}`;
    
    openChatBox(roomId, item.title);
}


        function openChatBox(roomId, title) {
            currentRoomId = roomId;
            const user = JSON.parse(localStorage.getItem('sudan_user_data'));
            document.getElementById('chat-title').innerText = title;
            navigate('pg-chat');

            db.ref('chats/' + roomId).on('value', (snap) => {
                let html = "";
                snap.forEach(c => {
                    const m = c.val();
                    html += `<div class="msg ${m.sender === user.phone ? 'me' : 'them'}">${m.text}</div>`;
                });
                const box = document.getElementById('chat-messages');
                box.innerHTML = html;
                box.scrollTop = box.scrollHeight;
            });
        }

        function sendMessage() {
    const input = document.getElementById('chat-input');
    const text = input.value.trim();
    const user = JSON.parse(localStorage.getItem('sudan_user_data'));

    if (!text || !currentRoomId) return;

    db.ref('chats/' + currentRoomId).push({
        sender: user.phone,
        senderName: user.name,
        text: text,
        timestamp: Date.now()
    }).then(() => {
        input.value = ""; // مسح الحقل بعد الإرسال
    }).catch((err) => {
        alert("خطأ في الإرسال: تأكد من اتصال الإنترنت");
    });
}


       function loadMyInbox(el) {
    const user = JSON.parse(localStorage.getItem('sudan_user_data'));
    if(!user) return alert("سجل دخولك أولاً");
    
    navigate('pg-my-list', el); // توجيه المستخدم لصفحة القائمة
    
    db.ref('chats').once('value', (snap) => {
        let html = "";
        let foundAny = false;
        
        snap.forEach(room => {
            if (room.key.includes(user.phone)) {
                foundAny = true;
                const messages = Object.values(room.val());
                const lastMsg = messages[messages.length - 1];
                
                html += `
                <div class="report-card" onclick="openChatBox('${room.key}', 'محادثة مستمرة')" style="border-right: 5px solid var(--accent);">
                    <div style="flex:1">
                        <h4 style="margin:0">${lastMsg.senderName || 'مستخدم'}</h4>
                        <p style="margin:5px 0; font-size:12px; color:var(--text-dim); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            ${lastMsg.text}
                        </p>
                    </div>
                    <i class="fas fa-chevron-left" style="align-self:center; color:var(--accent)"></i>
                </div>`;
            }
        });
        
        document.getElementById('my-list-container').innerHTML = foundAny ? html : "<p style='text-align:center; padding:20px;'>لا توجد محادثات نشطة حالياً</p>";
    });
}


        // --- عمليات البلاغات ---
        function publishReport() {
            const user = JSON.parse(localStorage.getItem('sudan_user_data'));
            const title = document.getElementById('inp-title').value;
            const desc = document.getElementById('inp-desc').value;
            const pin = document.getElementById('inp-pin').value;
            
            if(!title || !base64Image || pin.length < 4) return alert("يرجى إكمال كافة الحقول ورمز PIN");

            const reportData = {
                title, desc, phone: user.phone, pin, img: base64Image, type: currentType, timestamp: Date.now(),
                status: "official_record"
            };

            db.ref('reports').push(reportData).then(() => {
                alert("تم النشر بنجاح. هذا البلاغ أصبح جزءاً من سجلات المنصة الرسمية.");
                location.reload();
            });
        }

        function handleImageSelection(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    if(w > 800) { h = (800/w)*h; w = 800; }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    base64Image = canvas.toDataURL('image/jpeg', 0.7);
                    document.getElementById('img-preview').src = base64Image;
                    document.getElementById('img-preview').style.display = 'block';
                    document.getElementById('upload-placeholder').style.display = 'none';
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function deleteReport(id) {
            const item = allReports.find(r => r.id === id);
            const pin = prompt("أدخل رمز PIN المكون من 4 أرقام لتأكيد الحذف:");
            if (pin === item.pin) {
                if(confirm("هل تريد حذف البلاغ من السجلات العامة؟")) {
                    db.ref('reports').child(id).remove().then(() => { alert("تم الحذف."); navigate('pg-home'); });
                }
            } else { alert("رمز PIN غير صحيح."); }
        }

        function filterFeed(val) {
            const term = val.toLowerCase();
            const filtered = allReports.filter(r => r.title.toLowerCase().includes(term) || r.desc.toLowerCase().includes(term));
            renderFeed(filtered);
        }

        function showMyReports() {
            const user = JSON.parse(localStorage.getItem('sudan_user_data'));
            const myData = allReports.filter(r => r.phone === user.phone);
            let html = "";
            myData.forEach(item => {
                html += `<div class="report-card" onclick="viewDetails('${item.id}')"><img src="${item.img}"><div><h4>${item.title}</h4></div></div>`;
            });
            document.getElementById('my-list-container').innerHTML = html || "<p style='text-align:center'>ليس لديك بلاغات</p>";
            navigate('pg-my-list');
        }

        function saveUserData() {
            const name = document.getElementById('user-name-init').value.trim();
            const phone = document.getElementById('user-phone-init').value.trim();
            if(name.length < 10 || phone.length < 10) return alert("يرجى إدخال الاسم الرباعي ورقم هاتف صحيح");
            localStorage.setItem('sudan_user_data', JSON.stringify({name, phone}));
            document.getElementById('onboarding').style.display = 'none';
            updateProfileUI();
        }

        function updateProfileUI() {
            const user = JSON.parse(localStorage.getItem('sudan_user_data'));
            if(user) {
                document.querySelectorAll('.u-name').forEach(el => el.innerText = user.name);
                document.getElementById('u-phone-display').innerText = user.phone;
            }
        }

        function openForm(type) { currentType = type; navigate('pg-form'); }
        function logout() { if(confirm("تسجيل خروج؟")) { localStorage.clear(); location.reload(); } }
        function contactAction(type, phone) {
    // تنظيف رقم الهاتف من أي مسافات أو رموز
    let cleanPhone = phone.replace(/\s/g, '');
    
    if (type === 'tel') {
        window.location.href = "tel:" + cleanPhone;
    } else if (type === 'wa') {
        // تحويل الرقم لصيغة دولية سودانية إذا بدأ بـ 0
        let waPhone = cleanPhone;
        if (waPhone.startsWith('0')) {
            waPhone = "249" + waPhone.substring(1);
        }
        window.location.href = "https://wa.me/" + waPhone;
    }
}

        window.onload = () => {
            loadData();
            setTimeout(() => { document.getElementById('splash').style.display = 'none'; }, 2500);
            if(!localStorage.getItem('sudan_user_data')) document.getElementById('onboarding').style.display = 'flex';
            else updateProfileUI();
        };
    </script>
</body>
</html>
