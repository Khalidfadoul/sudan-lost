<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>مفقودات السودان 2026</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg: #e0e5ec; --text: #2d3436; --text-dim: #636e72; --accent: #2ecc71; --danger: #ff7675;
            --shadow: 9px 9px 16px rgba(163,177,198,0.6), -9px -9px 16px rgba(255,255,255, 0.5);
            --inner-shadow: inset 6px 6px 12px #c1c9d7, inset -6px -6px 12px #ffffff;
            --border: #d1d9e6;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; direction: rtl; overflow-x: hidden; }
        
        #splash { position: fixed; inset: 0; background: var(--bg); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .page { display: none; padding: 20px; padding-bottom: 100px; animation: fadeIn 0.4s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .user-chip { padding: 15px; border-radius: 20px; box-shadow: var(--shadow); display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .u-avatar { width: 45px; height: 45px; border-radius: 50%; box-shadow: var(--shadow); display: flex; align-items: center; justify-content: center; color: var(--accent); font-weight: bold; }
        .search-wrapper { background: var(--bg); padding: 15px; border-radius: 50px; box-shadow: var(--inner-shadow); display: flex; align-items: center; gap: 10px; }
        .search-wrapper input { background: transparent; border: none; outline: none; width: 100%; color: var(--text); }
        
        .report-card { background: var(--bg); padding: 12px; border-radius: 20px; box-shadow: var(--shadow); display: flex; gap: 15px; margin-bottom: 15px; cursor: pointer; }
        .report-card img { width: 70px; height: 70px; border-radius: 15px; object-fit: cover; }
        
        .badge { padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: bold; }
        .badge-lost { background: #ffeaa7; color: #d63031; }
        .badge-found { background: #55efc4; color: #00b894; }
        
        .btn-submit { width: 100%; padding: 18px; border-radius: 20px; border: none; background: var(--bg); box-shadow: var(--shadow); color: var(--accent); font-weight: bold; cursor: pointer; margin-top: 10px; text-align: center; font-size: 16px; display: block; text-decoration: none; }
        
        .det-header { width: 100%; height: 280px; border-radius: 25px; box-shadow: var(--inner-shadow); overflow: hidden; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; background: #f0f0f0; }
        .det-header img { max-width: 100%; max-height: 100%; object-fit: contain; }

        .bottom-nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 400px; height: 70px; background: rgba(224, 229, 236, 0.9); backdrop-filter: blur(10px); border-radius: 35px; display: flex; justify-content: space-around; align-items: center; box-shadow: var(--shadow); z-index: 1000; }
        .nav-item { color: var(--text-dim); text-align: center; font-size: 11px; cursor: pointer; flex: 1; }
        .nav-item.active { color: var(--accent); }
        .plus-center { width: 55px; height: 55px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white !important; margin-top: -40px; border: 4px solid var(--bg); font-size: 22px; }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .onboarding-card { background: var(--bg); padding: 30px; border-radius: 30px; box-shadow: var(--shadow); text-align: center; width: 100%; }
        .input-group { margin-bottom: 15px; }
        .input-group input, .input-group textarea { width: 100%; padding: 15px; border-radius: 15px; border: none; background: var(--bg); box-shadow: var(--inner-shadow); outline: none; font-size: 14px; }
        
        #chat-messages { display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 15px; border-radius: 15px; max-width: 80%; font-size: 14px; box-shadow: var(--shadow); }
        .msg.me { align-self: flex-start; background: var(--accent); color: white; }
        .msg.them { align-self: flex-end; background: white; color: var(--text); }
        
        
        /* =========================================
   SUDAN LOST - PREMIUM UI 2026
   Style: Neumorphic + Glassmorphism
   ========================================= 
*/

/* =========================================
   تحديث الألوان لعمق ووضوح أكبر
   ========================================= 
*/

:root {
    /* درجة خلفية أعمق قليلاً لإبراز التأثيرات */
    --bg: #ffffff; 
    --card: #d1d9e6; 
    --accent: #2ecc71; 
    --danger: #ff7675; 
    --text: #2d3436; 
    --text-dim: #5d6771; /* تعميق لون النص الفرعي للقراءة */
    
    /* تحديث الظلال لتناسب الخلفية الجديدة (أكثر حدة ووضوحاً) */
    --shadow: 8px 8px 16px #b8c1d1, -8px -8px 16px #ffffff;
    --inner-shadow: inset 6px 6px 12px #b8c1d1, inset -6px -6px 12px #ffffff;
    --border: rgba(255, 255, 255, 0.3);
}


* {
    -webkit-tap-highlight-color: transparent;
    user-select: none;
    box-sizing: border-box;
}

body {
    background-color: var(--bg);
    color: var(--text);
    margin: 0;
    font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    direction: rtl;
    overflow-x: hidden;
}

/* --- الهيدر الفاخر --- */
.main-header {
    padding: 30px 20px;
    background: var(--bg);
}

.user-chip {
    padding: 10px;
    border-radius: 20px;
    box-shadow: var(--shadow);
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 25px;
}

.u-avatar {
    width: 45px;
    height: 45px;
    background: var(--bg);
    border-radius: 50%;
    box-shadow: var(--shadow);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: var(--accent);
}

/* --- البحث المحفور (In-set Search) --- */
.search-wrapper {
    background: var(--bg);
    padding: 15px 20px;
    border-radius: 50px;
    box-shadow: var(--inner-shadow);
    display: flex;
    gap: 12px;
    border: none;
    align-items: center;
}

.search-wrapper input {
    background: transparent;
    border: none;
    outline: none;
    width: 100%;
    font-size: 15px;
    color: var(--text);
}

/* --- البطاقات البارزة (3D Raised Cards) --- */
.report-card {
    background: var(--bg);
    margin: 20px;
    padding: 15px;
    border-radius: 28px;
    display: flex;
    gap: 15px;
    box-shadow: var(--shadow);
    transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    border: 1px solid rgba(255,255,255,0.2);
}

.report-card:active {
    box-shadow: var(--inner-shadow);
    transform: scale(0.97);
}

.report-card img {
    width: 90px;
    height: 90px;
    border-radius: 20px;
    object-fit: cover;
    box-shadow: 4px 4px 8px rgba(0,0,0,0.1);
}

.card-body h4 {
    margin: 0;
    font-size: 17px;
    font-weight: 800;
}

.card-body p {
    font-size: 13px;
    color: var(--text-dim);
    margin: 5px 0;
}

/* --- التصنيفات (Soft Pills) --- */
.category-slider {
    display: flex;
    gap: 15px;
    overflow-x: auto;
    padding: 20px;
    scrollbar-width: none;
}

.cat-chip {
    padding: 12px 25px;
    background: var(--bg);
    border-radius: 50px;
    box-shadow: var(--shadow);
    font-size: 14px;
    font-weight: 600;
    color: var(--text-dim);
    transition: 0.3s;
    white-space: nowrap;
}

.cat-chip.active {
    box-shadow: var(--inner-shadow);
    color: var(--accent);
}

/* --- الملاحة العائمة (Floating Glass Nav) --- */
.bottom-nav {
    position: fixed;
    bottom: 25px;
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 420px;
    height: 75px;
    background: rgba(224, 229, 236, 0.85); /* تطابق لون الخلفية مع شفافية */
    backdrop-filter: blur(15px);
    border-radius: 40px;
    display: flex;
    justify-content: space-around;
    align-items: center;
    box-shadow: 20px 20px 40px rgba(163,177,198,0.5), -20px -20px 40px rgba(255,255,255,0.7);
    border: 1px solid rgba(255,255,255,0.4);
    z-index: 1000;
}

.nav-item {
    color: var(--text-dim);
    font-size: 13px;
    display: flex;
    flex-direction: column;
    align-items: center;
    transition: 0.3s;
}

.nav-item.active {
    color: var(--accent);
}

.plus-center {
    width: 65px;
    height: 65px;
    background: linear-gradient(135deg, #2ecc71, #27ae60);
    border-radius: 50%;
    margin-top: -60px;
    box-shadow: 0 10px 20px rgba(46, 204, 113, 0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white !important;
    font-size: 26px;
    border: 5px solid var(--bg);
}

/* --- المدخلات في النماذج --- */
.input-group input, .input-group textarea {
    background: var(--bg);
    border: none;
    box-shadow: var(--inner-shadow);
    border-radius: 18px;
    padding: 15px;
    width: 100%;
    color: var(--text);
    outline: none;
}

/* --- زر النشر الفاخر --- */
.btn-submit {
    width: 100%;
    padding: 18px;
    background: var(--bg);
    border-radius: 20px;
    box-shadow: var(--shadow);
    border: none;
    color: var(--accent);
    font-weight: 800;
    font-size: 16px;
    margin-top: 20px;
    transition: 0.3s;
}

.btn-submit:active {
    box-shadow: var(--inner-shadow);
    transform: scale(0.98);
}

/* --- الحركات --- */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.animate-item {
    animation: fadeIn 0.5s ease backwards;
}

/* تحسين عرض الصورة في الوضع الكامل */
/* عدل هذا الجزء فقط لضمان جودة الصورة */
.det-header {
    width: 100%;
    height: 300px; 
    background: #bdc3c7; /* خلفية محايدة */
    border-radius: 25px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    box-shadow: var(--inner-shadow);
}
.det-header img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain; /* هذا هو السر في عدم تشوه الصورة */
}

body {
    user-select: none; /* يمنع تحديد النصوص العام */
}
#details-view p {
    user-select: text; /* يسمح بنسخ تفاصيل البلاغ فقط */
}



    </style>
</head>
<body>

    <div id="splash">
        <i class="fas fa-search-location" style="font-size: 60px; color: var(--accent);"></i>
        <h1 style="margin-top: 20px;">مفقودات السودان</h1>
    </div>

    <div id="onboarding" class="modal-overlay" style="display:none;">
        <div class="onboarding-card">
            <h2>مرحباً بك</h2>
            <p>سجل بياناتك للبدء في استخدام التطبيق</p>
            <div class="input-group"><input type="text" id="user-name-init" placeholder="الاسم الكامل"></div>
            <div class="input-group"><input type="tel" id="user-phone-init" placeholder="رقم الهاتف"></div>
            <button class="btn-submit" onclick="saveUserData()">ابدأ الاستخدام</button>
        </div>
    </div>

    <main id="main-app">
        <section id="pg-home" class="page active">
            <header>
                <div class="user-chip">
                    <div class="u-avatar">م</div>
                    <div class="u-info"><span class="u-name">...</span></div>
                </div>
               <div class="search-wrapper">
    <i class="fas fa-search"></i>
    <input type="text" placeholder="ابحث عن مفقود، مكان، أو تفاصيل..." oninput="filterFeed(this.value)">
</div>

            </header>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">
                <div class="user-chip" style="justify-content:center; cursor:pointer;" onclick="openForm('lost')">
                    <i class="fas fa-minus-circle" style="color:var(--danger)"></i><span>فقدت شيئاً</span>
                </div>
                <div class="user-chip" style="justify-content:center; cursor:pointer;" onclick="openForm('found')">
                    <i class="fas fa-plus-circle" style="color:var(--accent)"></i><span>وجدت شيئاً</span>
                </div>
            </div>
            <div id="home-feed"></div>
            <button class="btn-submit" id="load-more-btn" style="display:none; margin-bottom:20px;" onclick="loadData(true)">تحميل المزيد</button>
        </section>

        <section id="pg-database" class="page">
            <h2>الأرشيف الشامل</h2>
            <div id="full-db-list"></div>
        </section>

        <section id="pg-stats" class="page">
            <h2 style="text-align: center;">إحصائيات 2026</h2>
            <div id="stats-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="user-chip" style="flex-direction:column; padding:25px;">
                    <h3 id="stat-lost-count" style="color:var(--danger); margin:0;">0</h3><span>مفقود</span>
                </div>
                <div class="user-chip" style="flex-direction:column; padding:25px;">
                    <h3 id="stat-found-count" style="color:var(--accent); margin:0;">0</h3><span>تم إيجاده</span>
                </div>
            </div>
        </section>

        <section id="pg-profile" class="page">
            <div class="user-chip" style="flex-direction: column; padding: 30px; text-align: center;">
                <div class="u-avatar" style="width: 80px; height: 80px; font-size: 30px; margin-bottom: 15px;">م</div>
                <h2 class="u-name">...</h2>
                <p id="u-phone-display" style="color: var(--text-dim);"></p>
            </div>
            <button class="btn-submit" onclick="showMyReports()"><i class="fas fa-list"></i> بلاغاتي الشخصية</button>
            <button class="btn-submit" onclick="loadMyInbox()"><i class="fas fa-envelope"></i> رسائلي والردود</button>

            <button class="btn-submit" style="color:var(--danger)" onclick="logout()">تسجيل الخروج</button>
        </section>

        <section id="pg-my-reports" class="page">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:20px">
                <i class="fas fa-arrow-right" onclick="navigate('pg-profile')"></i> <h2>بلاغاتي</h2>
            </div>
            <div id="my-reports-list"></div>
        </section>

        <section id="pg-details" class="page">
            <div id="details-view"></div>
        </section>

        <section id="pg-form" class="page">
            <h2 id="form-title">نشر بلاغ</h2>
            <div class="input-group" style="height:180px; background:var(--bg); box-shadow:var(--inner-shadow); border-radius:20px; display:flex; align-items:center; justify-content:center; overflow:hidden" onclick="document.getElementById('file-input').click()">
                <img id="img-preview" style="width:100%; height:100%; object-fit:cover; display:none">
                <div id="upload-placeholder"><i class="fas fa-camera" style="font-size:30px; color:var(--accent)"></i><br>أضف صورة</div>
                <input type="file" id="file-input" hidden onchange="handleImageSelection(event)">
            </div>
            <div class="input-group"><input type="text" id="inp-title" placeholder="عنوان البلاغ (مثلاً: مفتاح سيارة)"></div>
            <div class="input-group"><textarea id="inp-desc" rows="4" placeholder="التفاصيل المكان والزمان..."></textarea></div>
            <div class="input-group"><input type="number" id="inp-pin" placeholder="رمز الحماية PIN (4 أرقام)"></div>
            <button class="btn-submit" onclick="publishReport()">نشر البلاغ الآن</button>
            <button class="btn-submit" style="box-shadow:none; background:transparent;" onclick="navigate('pg-home')">إلغاء</button>
        </section>
        
        <section id="pg-chat-view" class="page">
            <div id="chat-header" style="display:flex; align-items:center; gap:10px; margin-bottom:15px;">
                <i class="fas fa-arrow-right" onclick="navigate('pg-home')"></i>
                <h3 id="chat-with-name" style="margin:0;">الدردشة</h3>
            </div>
            <div id="chat-messages" style="height: 60vh; overflow-y: auto; background: var(--bg); box-shadow: var(--inner-shadow); border-radius: 20px; padding: 15px; margin-bottom: 15px;">
            </div>
            <div class="search-wrapper">
                <input type="text" id="chat-input" placeholder="اكتب رسالة...">
                <i class="fas fa-paper-plane" id="send-btn" style="color: var(--accent); cursor: pointer; padding: 10px;"></i>
            </div>
        </section>
    </main>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="navigate('pg-home', this)"><i class="fas fa-home"></i><br>الرئيسية</div>
        <div class="nav-item" onclick="navigate('pg-database', this)"><i class="fas fa-database"></i><br>الأرشيف</div>
        <div class="nav-item plus-center" onclick="openForm('lost')"><i class="fas fa-plus"></i></div>
        <div class="nav-item" onclick="navigate('pg-stats', this)"><i class="fas fa-chart-pie"></i><br>إحصائيات</div>
        <div class="nav-item" onclick="navigate('pg-profile', this)"><i class="fas fa-user"></i><br>حسابي</div>
    </nav>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCybHxby_BWoisXHKg5PYEzNgRosBvH66Y",
            authDomain: "mafgoodsudan-b76ab.firebaseapp.com",
            databaseURL: "https://mafgoodsudan-b76ab-default-rtdb.firebaseio.com",
            projectId: "mafgoodsudan-b76ab",
            storageBucket: "mafgoodsudan-b76ab.appspot.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let allReports = [];
        let currentType = 'lost';
        let base64Image = "";
        let lastTimestamp = null;
        let currentChatRef = null;

        // --- الملاحة ---
        function navigate(pageId, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            if(el) {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                el.classList.add('active');
            }
            if(pageId === 'pg-stats') updateStats();
            if(pageId === 'pg-profile') updateProfileUI();
        }

        // --- الصور ---
        function handleImageSelection(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
            // إعداد أبعاد الصورة المضغوطة (مثلاً عرض 800 بكسل كحد أقصى)
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            const maxWidth = 800; 

            if (width > maxWidth) {
                height = (maxWidth / width) * height;
                width = maxWidth;
            }

            canvas.width = width;
            canvas.height = height;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            // تحويل الصورة إلى base64 بجودة 0.7 (70% من الجودة الأصلية)
            // هذا يقلل الحجم من 5 ميجا إلى حوالي 100-200 كيلوبايت فقط!
            base64Image = canvas.toDataURL('image/jpeg', 0.7);

            // تحديث العرض في التطبيق
            document.getElementById('img-preview').src = base64Image;
            document.getElementById('img-preview').style.display = 'block';
            document.getElementById('upload-placeholder').style.display = 'none';
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}


        // --- جلب البيانات مع Pagination ---
        function loadData(isMore = false) {
            let query = db.ref('reports').orderByChild('timestamp').limitToLast(10);
            if (isMore && lastTimestamp) {
                query = db.ref('reports').orderByChild('timestamp').endAt(lastTimestamp - 1).limitToLast(10);
            }

            query.once('value', (snap) => {
                let items = [];
                snap.forEach(child => { items.push({ id: child.key, ...child.val() }); });
                items.reverse();

                if (items.length > 0) {
                    lastTimestamp = items[items.length - 1].timestamp;
                    allReports = isMore ? [...allReports, ...items] : items;
                    renderFeed(allReports);
                    document.getElementById('load-more-btn').style.display = items.length === 10 ? 'block' : 'none';
                }
            });
        }

        function renderFeed(data) {
            let html = "";
            data.forEach(item => {
                html += `
                <div class="report-card" onclick="viewDetails('${item.id}')">
                    <img src="${item.img || 'https://via.placeholder.com/80'}">
                    <div style="flex:1">
                        <h4 style="margin:0 0 5px 0;">${item.title}</h4>
                        <span class="badge ${item.type==='lost'?'badge-lost':'badge-found'}">
                            ${item.type==='lost'?'مفقود':'موجود'}
                        </span>
                    </div>
                    <i class="fas fa-chevron-left" style="align-self:center; color:#ccc;"></i>
                </div>`;
            });
            document.getElementById('home-feed').innerHTML = html || "لا توجد بلاغات حالياً";
            document.getElementById('full-db-list').innerHTML = html;
        }

        // --- التفاصيل، الاتصال، والمشاركة ---
        function viewDetails(id) {
            const item = allReports.find(r => r.id === id);
            if (!item) return;

            document.getElementById('details-view').innerHTML = `
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:20px">
                    <i class="fas fa-arrow-right" onclick="navigate('pg-home')"></i> <h2>تفاصيل البلاغ</h2>
                </div>
                <div class="det-header">
                    <img src="${item.img}" alt="صورة البلاغ">
                </div>
                <div class="user-chip" style="display:block; padding:20px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                        <span class="badge ${item.type === 'lost' ? 'badge-lost' : 'badge-found'}">${item.type === 'lost' ? 'مفقود' : 'موجود'}</span>
                        <small style="color:var(--text-dim)">${new Date(item.timestamp).toLocaleDateString('ar-EG')}</small>
                    </div>
                    <h3 style="margin-top:0;">${item.title}</h3>
                    <p style="line-height:1.6; color:var(--text); font-size:15px;">${item.desc}</p>
                </div>
                
                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button onclick="contactAction('tel', '${item.phone}')" class="btn-submit" style="background:var(--accent); color:white; flex:2; margin-top:0;">
                        <i class="fas fa-phone"></i> اتصل
                    </button>
                    <button onclick="contactAction('wa', '${item.phone}')" class="btn-submit" style="background:#25D366; color:white; flex:2; margin-top:0;">
                        <i class="fab fa-whatsapp"></i> واتساب
                    </button>
                </div>

                <button onclick="startChat('${item.id}')" class="btn-submit" style="background:var(--text); color:white;">
                    <i class="fas fa-comments"></i> دردشة داخل التطبيق
                </button>
                
                <button onclick="deleteReport('${item.id}')" style="width:100%; background:none; border:none; color:var(--danger); margin-top:30px; font-weight:bold; cursor:pointer;">
                    <i class="fas fa-trash"></i> حذف البلاغ (يتطلب الهاتف و PIN)
                </button>
            `;
            navigate('pg-details');
        }

       function contactAction(type, phone) {
    let cleanPhone = phone.replace(/\s+/g, '').replace(/^0/, '');
    if (!cleanPhone.startsWith('249')) cleanPhone = '249' + cleanPhone;

    if (type === 'tel') {
        window.location.href = "tel:" + cleanPhone;
    } else {
        // استخدام رابط https بدلاً من whatsapp:// يحل مشكلة التوافق في الـ WebView
        // ويعمل كـ Deep Link لفتح التطبيق مباشرة
        window.location.href = "https://api.whatsapp.com/send?phone=" + cleanPhone;
    }
}


        // --- الحذف والعمليات ---
        function publishReport() {
            const user = JSON.parse(localStorage.getItem('sudan_user_data'));
            const title = document.getElementById('inp-title').value;
            const desc = document.getElementById('inp-desc').value;
            const pin = document.getElementById('inp-pin').value;
            
            if(!title || !base64Image || !pin) return alert("الرجاء إضافة صورة، عنوان، ورمز PIN");

            db.ref('reports').push({
                title, desc, phone: user.phone, pin, img: base64Image, type: currentType, timestamp: Date.now()
            }).then(() => {
                alert("تم النشر بنجاح");
                location.reload();
            });
        }

        function deleteReport(id) {
    const item = allReports.find(r => r.id === id);
    const user = JSON.parse(localStorage.getItem('sudan_user_data'));

    // 1. التحقق من أن المستخدم هو صاحب البلاغ (برمجياً)
    if (String(item.phone) !== String(user.phone)) {
        return alert("خطأ: لا يمكنك حذف بلاغ لم تنشره من هذا الهاتف.");
    }

    // 2. طلب الـ PIN للتأكيد
    const pin = prompt("أدخل رمز PIN المكون من 4 أرقام المخصص لهذا البلاغ:");
    
    if (String(item.pin) === String(pin)) {
        if (confirm("هل أنت متأكد من حذف البلاغ نهائياً؟")) {
            // تنفيذ الحذف من Firebase
            db.ref('reports').child(id).remove()
                .then(() => {
                    alert("تم حذف البلاغ بنجاح");
                    location.reload(); // تحديث الصفحة لرؤية النتائج
                })
                .catch((error) => {
                    alert("حدث خطأ أثناء الحذف: " + error.message);
                });
        }
    } else {
        alert("رمز PIN غير صحيح، يرجى المحاولة مرة أخرى.");
    }
}


        // --- الدردشة ---
        // دالة لبدء الدردشة أو الدخول إليها
// --- تحديث نظام الدردشة المطور ---

// 1. دالة لبدء دردشة جديدة (من صفحة التفاصيل)
function startChat(reportId) {
    const item = allReports.find(r => r.id === reportId);
    const user = JSON.parse(localStorage.getItem('sudan_user_data'));
    
    if (user.phone === item.phone) {
        alert("هذا بلاغك، يمكنك رؤية الردود من صفحة 'حسابي' قريباً");
        return;
    }

    // معرف غرفة فريد يجمع الطرفين
    const roomId = `chat_${reportId}_${item.phone}_${user.phone}`;
    openChatBox(roomId, item.title);
}

// 2. دالة لفتح واجهة الدردشة وتحميل الرسائل
function openChatBox(roomId, title) {
    const user = JSON.parse(localStorage.getItem('sudan_user_data'));
    document.getElementById('chat-with-name').innerText = title;
    navigate('pg-chat-view');

    const sendBtn = document.getElementById('send-btn');
    const chatInput = document.getElementById('chat-input');

    // إرسال رسالة
    sendBtn.onclick = () => {
        const text = chatInput.value.trim();
        if (!text) return;
        
        db.ref('chats/' + roomId).push({
            sender: user.phone,
            senderName: user.name,
            text: text,
            timestamp: Date.now()
        });
        chatInput.value = "";
    };

    // الاستماع للرسائل
    if (currentChatRef) currentChatRef.off();
    currentChatRef = db.ref('chats/' + roomId);
    currentChatRef.on('value', (snap) => {
        let html = "";
        snap.forEach(child => {
            const m = child.val();
            const isMe = m.sender === user.phone;
            html += `<div class="msg ${isMe ? 'me' : 'them'}">
                        <small style="font-size:9px; display:block; opacity:0.6">${m.senderName}</small>
                        ${m.text}
                     </div>`;
        });
        const box = document.getElementById('chat-messages');
        box.innerHTML = html;
        box.scrollTop = box.scrollHeight;
    });
}

// 3. دالة سحرية لصاحب البلاغ (توضع في صفحة البروفايل)
// تقوم بمسح كافة المحادثات والعثور على الغرف التي يشارك فيها المستخدم
function loadMyInbox() {
    const user = JSON.parse(localStorage.getItem('sudan_user_data'));
    const inboxRef = db.ref('chats');
    
    inboxRef.once('value', (snap) => {
        let html = "<h3>محادثاتي</h3>";
        let found = false;
        
        snap.forEach(room => {
            const roomId = room.key;
            // التحقق إذا كان رقم هاتف المستخدم جزءاً من اسم الغرفة
            if (roomId.includes(user.phone)) {
                found = true;
                const lastMsg = Object.values(room.val()).pop(); // جلب آخر رسالة
                html += `
                <div class="report-card" onclick="openChatBox('${roomId}', 'محادثة سابقة')">
                    <div style="flex:1">
                        <h4 style="margin:0">${lastMsg.senderName}</h4>
                        <p style="margin:5px 0; font-size:12px">${lastMsg.text}</p>
                    </div>
                    <i class="fas fa-comments" style="color:var(--accent)"></i>
                </div>`;
            }
        });
        
        if (!found) html += "<p style='text-align:center'>لا توجد رسائل بعد</p>";
        
        // عرض النتائج (يمكنك وضعها في قسم جديد أو نافذة منبثقة)
        document.getElementById('my-reports-list').innerHTML = html; 
        navigate('pg-my-reports');
    });
}



        // --- إعدادات الحساب والإحصائيات ---
        function updateStats() {
            db.ref('reports').once('value', (snap) => {
                let l = 0, f = 0;
                snap.forEach(c => {
                    if(c.val().type === 'lost') l++; else f++;
                });
                document.getElementById('stat-lost-count').innerText = l;
                document.getElementById('stat-found-count').innerText = f;
            });
        }

        function showMyReports() {
            const user = JSON.parse(localStorage.getItem('sudan_user_data'));
            const myData = allReports.filter(r => r.phone === user.phone);
            let html = "";
            myData.forEach(item => {
                html += `<div class="report-card" onclick="viewDetails('${item.id}')"><img src="${item.img}"><div><h4>${item.title}</h4><span class="badge">بلاغي</span></div></div>`;
            });
            document.getElementById('my-reports-list').innerHTML = html || "لا توجد بلاغات";
            navigate('pg-my-reports');
        }

        function saveUserData() {
            const name = document.getElementById('user-name-init').value;
            const phone = document.getElementById('user-phone-init').value;
            if(!name || !phone) return alert("أدخل البيانات");
            localStorage.setItem('sudan_user_data', JSON.stringify({name, phone}));
            document.getElementById('onboarding').style.display = 'none';
            updateProfileUI();
        }

        function updateProfileUI() {
            const user = JSON.parse(localStorage.getItem('sudan_user_data'));
            if(user) {
                document.querySelectorAll('.u-name').forEach(el => el.innerText = user.name);
                document.getElementById('u-phone-display').innerText = user.phone;
            }
        }

function showMyChats() {
    const user = JSON.parse(localStorage.getItem('sudan_user_data'));
    alert("سيتم إدراج قائمة المحادثات هنا قريباً. حالياً يمكنك الرد على من راسلك عبر الدخول لبلاغك.");
    // تطوير مستقبلي: جلب كافة الغرف التي تحتوي على رقم هاتفه
}

        function logout() { if(confirm("خروج؟")) { localStorage.clear(); location.reload(); } }
        function filterFeed(val) {
    // تحويل نص البحث إلى حروف صغيرة لضمان مطابقة دقيقة
    const searchTerm = val.toLowerCase().trim();

    const filtered = allReports.filter(report => {
        // البحث في العنوان
        const titleMatch = report.title && report.title.toLowerCase().includes(searchTerm);
        
        // البحث في التفاصيل (الوصف)
        const descMatch = report.desc && report.desc.toLowerCase().includes(searchTerm);
        
        // إرجاع البلاغ إذا وجدنا الكلمة في العنوان أو الوصف
        return titleMatch || descMatch;
    });

    // إعادة عرض البلاغات المفلترة فقط
    renderFeed(filtered);
}

        function openForm(type) { currentType = type; document.getElementById('form-title').innerText = type === 'lost' ? "فقدت شيئاً" : "وجدت شيئاً"; navigate('pg-form'); }

        window.onload = () => {
            loadData();
            setTimeout(() => { document.getElementById('splash').style.display = 'none'; }, 1500);
            if(!localStorage.getItem('sudan_user_data')) document.getElementById('onboarding').style.display = 'flex';
            else updateProfileUI();
        };
    </script>
</body>
</html>
