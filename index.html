<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ù…ÙÙ‚ÙˆØ¯Ø§Øª Ø§Ù„Ø³ÙˆØ¯Ø§Ù† 2026</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg: #f0f2f5; 
            --accent: #2ecc71; 
            --danger: #ff7675; 
            --text: #2d3436; 
            --text-dim: #5d6771;
            --shadow: 8px 8px 16px #d1d9e6, -8px -8px 16px #ffffff;
            --inner-shadow: inset 6px 6px 12px #d1d9e6, inset -6px -6px 12px #ffffff;
        }

        * { -webkit-tap-highlight-color: transparent; user-select: none; box-sizing: border-box; }
        body { background-color: var(--bg); color: var(--text); margin: 0; font-family: sans-serif; direction: rtl; overflow-x: hidden; }
        
        /* Splash Screen */
        #splash { position: fixed; inset: 0; background: var(--bg); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        /* Pages */
        .page { display: none; padding: 20px; padding-bottom: 100px; animation: fadeIn 0.4s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* UI Elements */
        .user-chip { padding: 15px; border-radius: 20px; box-shadow: var(--shadow); display: flex; align-items: center; gap: 15px; margin-bottom: 20px; background: var(--bg); }
        .u-avatar { width: 45px; height: 45px; border-radius: 50%; box-shadow: var(--shadow); display: flex; align-items: center; justify-content: center; color: var(--accent); font-weight: bold; }
        
        .search-wrapper { background: var(--bg); padding: 15px 20px; border-radius: 50px; box-shadow: var(--inner-shadow); display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
        .search-wrapper input { background: transparent; border: none; outline: none; width: 100%; color: var(--text); font-size: 15px; }
        
        .report-card { background: var(--bg); padding: 15px; border-radius: 25px; box-shadow: var(--shadow); display: flex; gap: 15px; margin-bottom: 15px; cursor: pointer; border: 1px solid rgba(255,255,255,0.2); transition: 0.2s; }
        .report-card:active { box-shadow: var(--inner-shadow); transform: scale(0.98); }
        .report-card img { width: 80px; height: 80px; border-radius: 18px; object-fit: cover; }
        
        .badge { padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: bold; }
        .badge-lost { background: #ffeaa7; color: #d63031; }
        .badge-found { background: #55efc4; color: #00b894; }
        
        .btn-submit { width: 100%; padding: 18px; border-radius: 20px; border: none; background: var(--bg); box-shadow: var(--shadow); color: var(--accent); font-weight: 800; cursor: pointer; margin-top: 15px; text-align: center; font-size: 16px; transition: 0.3s; }
        .btn-submit:active { box-shadow: var(--inner-shadow); }

        /* Details View */
        .det-header { width: 100%; height: 300px; border-radius: 25px; box-shadow: var(--inner-shadow); overflow: hidden; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; background: #e0e5ec; }
        .det-header img { max-width: 100%; max-height: 100%; object-fit: contain; }

        /* Navigation */
        .bottom-nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 420px; height: 75px; background: rgba(240, 242, 245, 0.9); backdrop-filter: blur(15px); border-radius: 35px; display: flex; justify-content: space-around; align-items: center; box-shadow: var(--shadow); z-index: 1000; border: 1px solid rgba(255,255,255,0.4); }
        .nav-item { color: var(--text-dim); text-align: center; font-size: 11px; cursor: pointer; flex: 1; transition: 0.3s; }
        .nav-item.active { color: var(--accent); }
        .plus-center { width: 60px; height: 60px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white !important; margin-top: -45px; border: 5px solid var(--bg); font-size: 24px; box-shadow: 0 10px 20px rgba(46, 204, 113, 0.3); }
        
        /* Chat */
        #chat-messages { display: flex; flex-direction: column; gap: 10px; height: 60vh; overflow-y: auto; padding: 5px; }
        .msg { padding: 12px 18px; border-radius: 20px; max-width: 80%; font-size: 14px; box-shadow: var(--shadow); }
        .msg.me { align-self: flex-start; background: var(--accent); color: white; border-bottom-right-radius: 5px; }
        .msg.them { align-self: flex-end; background: white; color: var(--text); border-bottom-left-radius: 5px; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .onboarding-card { background: var(--bg); padding: 30px; border-radius: 30px; box-shadow: var(--shadow); text-align: center; width: 100%; max-width: 400px; }
        .input-group { margin-bottom: 15px; }
        .input-group input, .input-group textarea { width: 100%; padding: 15px; border-radius: 15px; border: none; background: var(--bg); box-shadow: var(--inner-shadow); outline: none; font-size: 14px; color: var(--text); }
    </style>
</head>
<body>

    <div id="splash">
        <i class="fas fa-search-location" style="font-size: 70px; color: var(--accent);"></i>
        <h1 style="margin-top: 20px; font-weight: 900;">Ù…ÙÙ‚ÙˆØ¯Ø§Øª Ø§Ù„Ø³ÙˆØ¯Ø§Ù†</h1>
    </div>

    <div id="onboarding" class="modal-overlay" style="display:none;">
        <div class="onboarding-card">
            <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ğŸ‘‹</h2>
            <p>Ø³Ø¬Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„Ù„Ø¨Ø¯Ø¡ ÙÙŠ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†</p>
            <div class="input-group"><input type="text" id="user-name-init" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„"></div>
            <div class="input-group"><input type="tel" id="user-phone-init" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ"></div>
            <button class="btn-submit" onclick="saveUserData()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</button>
        </div>
    </div>

    <main id="main-app">
        <section id="pg-home" class="page active">
            <header>
                <div class="user-chip">
                    <div class="u-avatar">ğŸ‘¤</div>
                    <div class="u-info"><span class="u-name">...</span></div>
                </div>
                <div class="search-wrapper">
                    <i class="fas fa-search" style="color: var(--text-dim);"></i>
                    <input type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…ÙÙ‚ÙˆØ¯ØŒ Ù…ÙƒØ§Ù†ØŒ Ø£Ùˆ ØªÙØ§ØµÙŠÙ„..." oninput="filterFeed(this.value)">
                </div>
            </header>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px;">
                <div class="user-chip" style="justify-content:center; cursor:pointer;" onclick="openForm('lost')">
                    <i class="fas fa-minus-circle" style="color:var(--danger)"></i><span>ÙÙ‚Ø¯Øª Ø´ÙŠØ¦Ø§Ù‹</span>
                </div>
                <div class="user-chip" style="justify-content:center; cursor:pointer;" onclick="openForm('found')">
                    <i class="fas fa-plus-circle" style="color:var(--accent)"></i><span>ÙˆØ¬Ø¯Øª Ø´ÙŠØ¦Ø§Ù‹</span>
                </div>
            </div>
            <div id="home-feed"></div>
            <button class="btn-submit" id="load-more-btn" style="display:none; margin-bottom:20px;" onclick="loadData(true)">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯</button>
        </section>

        <section id="pg-database" class="page">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:20px">
                <i class="fas fa-arrow-right" onclick="navigate('pg-home')"></i> <h2>Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø´Ø§Ù…Ù„</h2>
            </div>
            <div id="full-db-list"></div>
        </section>

        <section id="pg-stats" class="page">
            <h2 style="text-align: center; margin-bottom: 30px;">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª 2026</h2>
            <div id="stats-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="user-chip" style="flex-direction:column; padding:30px;">
                    <h1 id="stat-lost-count" style="color:var(--danger); margin:0;">0</h1><span>Ù…ÙÙ‚ÙˆØ¯</span>
                </div>
                <div class="user-chip" style="flex-direction:column; padding:30px;">
                    <h1 id="stat-found-count" style="color:var(--accent); margin:0;">0</h1><span>ØªÙ… Ø¥ÙŠØ¬Ø§Ø¯Ù‡</span>
                </div>
            </div>
        </section>

        <section id="pg-profile" class="page">
            <div class="user-chip" style="flex-direction: column; padding: 40px; text-align: center;">
                <div class="u-avatar" style="width: 90px; height: 90px; font-size: 35px; margin-bottom: 15px;">ğŸ‘¤</div>
                <h2 class="u-name">...</h2>
                <p id="u-phone-display" style="color: var(--text-dim);"></p>
            </div>
            <button class="btn-submit" onclick="showMyReports()"><i class="fas fa-list"></i> Ø¨Ù„Ø§ØºØ§ØªÙŠ Ø§Ù„Ø´Ø®ØµÙŠØ©</button>
            <button class="btn-submit" onclick="loadMyInbox()"><i class="fas fa-envelope"></i> Ø±Ø³Ø§Ø¦Ù„ÙŠ ÙˆØ§Ù„Ø±Ø¯ÙˆØ¯</button>
            <button class="btn-submit" style="color:var(--danger); margin-top: 30px; box-shadow: none;" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </section>

        <section id="pg-my-reports" class="page">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:20px">
                <i class="fas fa-arrow-right" onclick="navigate('pg-profile')"></i> <h2 id="list-title">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</h2>
            </div>
            <div id="my-reports-list"></div>
        </section>

        <section id="pg-details" class="page">
            <div id="details-view"></div>
        </section>

        <section id="pg-form" class="page">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:20px">
                <i class="fas fa-arrow-right" onclick="navigate('pg-home')"></i> <h2 id="form-title">Ù†Ø´Ø± Ø¨Ù„Ø§Øº</h2>
            </div>
            <div class="input-group" style="height:220px; background:var(--bg); box-shadow:var(--inner-shadow); border-radius:25px; display:flex; align-items:center; justify-content:center; overflow:hidden" onclick="document.getElementById('file-input').click()">
                <img id="img-preview" style="width:100%; height:100%; object-fit:cover; display:none">
                <div id="upload-placeholder" style="text-align:center"><i class="fas fa-camera" style="font-size:40px; color:var(--accent)"></i><br>Ø£Ø¶Ù ØµÙˆØ±Ø© ÙˆØ§Ø¶Ø­Ø©</div>
                <input type="file" id="file-input" hidden onchange="handleImageSelection(event)">
            </div>
            <div class="input-group"><input type="text" id="inp-title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¨Ù„Ø§Øº (Ù…Ø«Ù„Ø§Ù‹: Ù…ÙØªØ§Ø­ Ø³ÙŠØ§Ø±Ø© ØªÙˆÙŠÙˆØªØ§)"></div>
            <div class="input-group"><textarea id="inp-desc" rows="4" placeholder="Ø§Ù„ØªÙØ§ØµÙŠÙ„: Ø§Ù„Ù…ÙƒØ§Ù†ØŒ Ø§Ù„Ø²Ù…Ø§Ù†ØŒ ÙˆØ£ÙŠ Ø¹Ù„Ø§Ù…Ø§Øª Ù…Ù…ÙŠØ²Ø©..."></textarea></div>
            <div class="input-group"><input type="number" id="inp-pin" placeholder="Ø±Ù…Ø² Ø­Ù…Ø§ÙŠØ© Ù„Ù„Ø­Ø°Ù PIN (4 Ø£Ø±Ù‚Ø§Ù…)"></div>
            <button class="btn-submit" style="background:var(--accent); color:white;" onclick="publishReport()">Ù†Ø´Ø± Ø§Ù„Ø¨Ù„Ø§Øº Ø§Ù„Ø¢Ù†</button>
        </section>
        
        <section id="pg-chat-view" class="page">
            <div id="chat-header" style="display:flex; align-items:center; gap:15px; margin-bottom:20px;">
                <i class="fas fa-arrow-right" onclick="navigate('pg-home')"></i>
                <h3 id="chat-with-name" style="margin:0;">Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</h3>
            </div>
            <div id="chat-messages" style="background: var(--bg); box-shadow: var(--inner-shadow); border-radius: 25px; padding: 20px; margin-bottom: 15px;"></div>
            <div class="search-wrapper">
                <input type="text" id="chat-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§...">
                <i class="fas fa-paper-plane" id="send-btn" style="color: var(--accent); cursor: pointer; padding: 10px; font-size: 20px;"></i>
            </div>
        </section>
    </main>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="navigate('pg-home', this)"><i class="fas fa-home"></i><br>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        <div class="nav-item" onclick="navigate('pg-database', this)"><i class="fas fa-database"></i><br>Ø§Ù„Ø£Ø±Ø´ÙŠÙ</div>
        <div class="nav-item plus-center" onclick="openForm('lost')"><i class="fas fa-plus"></i></div>
        <div class="nav-item" onclick="navigate('pg-stats', this)"><i class="fas fa-chart-pie"></i><br>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div>
        <div class="nav-item" onclick="navigate('pg-profile', this)"><i class="fas fa-user"></i><br>Ø­Ø³Ø§Ø¨ÙŠ</div>
    </nav>

    <script>
        // --- ØªÙ‡ÙŠØ¦Ø© Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyCybHxby_BWoisXHKg5PYEzNgRosBvH66Y",
            authDomain: "mafgoodsudan-b76ab.firebaseapp.com",
            databaseURL: "https://mafgoodsudan-b76ab-default-rtdb.firebaseio.com",
            projectId: "mafgoodsudan-b76ab",
            storageBucket: "mafgoodsudan-b76ab.appspot.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let allReports = [];
        let currentType = 'lost';
        let base64Image = "";
        let lastTimestamp = null;
        let currentChatRef = null;

        // --- Ø§Ù„Ù…Ù„Ø§Ø­Ø© ÙˆØ§Ù„ØªØ­ÙƒÙ… ---
        function navigate(pageId, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            if(el) {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                el.classList.add('active');
            }
            if(pageId === 'pg-stats') updateStats();
            if(pageId === 'pg-profile') updateProfileUI();
            window.scrollTo(0,0);
        }

        // --- Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ± ---
        function handleImageSelection(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width, height = img.height, maxWidth = 800;
                    if (width > maxWidth) { height = (maxWidth / width) * height; width = maxWidth; }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    base64Image = canvas.toDataURL('image/jpeg', 0.7);
                    document.getElementById('img-preview').src = base64Image;
                    document.getElementById('img-preview').style.display = 'block';
                    document.getElementById('upload-placeholder').style.display = 'none';
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // --- Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
        function loadData(isMore = false) {
            let query = db.ref('reports').orderByChild('timestamp').limitToLast(12);
            if (isMore && lastTimestamp) query = db.ref('reports').orderByChild('timestamp').endAt(lastTimestamp - 1).limitToLast(12);

            query.once('value', (snap) => {
                let items = [];
                snap.forEach(child => { items.push({ id: child.key, ...child.val() }); });
                items.reverse();
                if (items.length > 0) {
                    lastTimestamp = items[items.length - 1].timestamp;
                    allReports = isMore ? [...allReports, ...items] : items;
                    renderFeed(allReports);
                    document.getElementById('load-more-btn').style.display = items.length >= 10 ? 'block' : 'none';
                }
            });
        }

        function renderFeed(data) {
            let html = "";
            data.forEach(item => {
                html += `
                <div class="report-card" onclick="viewDetails('${item.id}')">
                    <img src="${item.img || 'https://via.placeholder.com/80'}">
                    <div style="flex:1">
                        <h4 style="margin:0 0 5px 0;">${item.title}</h4>
                        <span class="badge ${item.type==='lost'?'badge-lost':'badge-found'}">${item.type==='lost'?'Ù…ÙÙ‚ÙˆØ¯':'Ù…ÙˆØ¬ÙˆØ¯'}</span>
                    </div>
                </div>`;
            });
            document.getElementById('home-feed').innerHTML = html || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù„Ø§ØºØ§Øª";
            document.getElementById('full-db-list').innerHTML = html;
        }

        // --- Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙˆØ§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ---
        function viewDetails(id) {
            const item = allReports.find(r => r.id === id);
            if (!item) return;
            document.getElementById('details-view').innerHTML = `
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:20px"><i class="fas fa-arrow-right" onclick="navigate('pg-home')"></i> <h2>Ø§Ù„ØªÙØ§ØµÙŠÙ„</h2></div>
                <div class="det-header"><img src="${item.img}"></div>
                <div class="user-chip" style="display:block; padding:20px;">
                    <h3>${item.title}</h3>
                    <p style="user-select:text; line-height:1.6;">${item.desc}</p>
                </div>
                <div style="display:flex; gap:12px; margin-top:20px;">
                    <button onclick="contactAction('tel', '${item.phone}')" class="btn-submit" style="background:var(--accent); color:white; flex:1; margin:0">Ø§ØªØµØ§Ù„</button>
                    <button onclick="contactAction('wa', '${item.phone}')" class="btn-submit" style="background:#25D366; color:white; flex:1; margin:0">ÙˆØ§ØªØ³Ø§Ø¨</button>
                </div>
                <button onclick="startChat('${item.id}')" class="btn-submit" style="background:var(--text); color:white;">Ø¯Ø±Ø¯Ø´Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button>
                <button onclick="deleteReport('${item.id}')" style="width:100%; border:none; background:none; color:var(--danger); margin-top:25px; font-weight:bold;">Ø­Ø°Ù Ø§Ù„Ø¨Ù„Ø§Øº</button>
            `;
            navigate('pg-details');
        }

        function contactAction(type, phone) {
            let clean = phone.replace(/\s+/g, '').replace(/^0/, '');
            if (!clean.startsWith('249')) clean = '249' + clean;
            window.location.href = type === 'tel' ? "tel:" + clean : "https://api.whatsapp.com/send?phone=" + clean;
        }

        function publishReport() {
            const user = JSON.parse(localStorage.getItem('sudan_user_data'));
            const title = document.getElementById('inp-title').value, desc = document.getElementById('inp-desc').value, pin = document.getElementById('inp-pin').value;
            if(!title || !base64Image || !pin) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
            db.ref('reports').push({ title, desc, phone: user.phone, pin, img: base64Image, type: currentType, timestamp: Date.now() }).then(() => location.reload());
        }

        function deleteReport(id) {
            const item = allReports.find(r => r.id === id);
            const user = JSON.parse(localStorage.getItem('sudan_user_data'));
            if (String(item.phone) !== String(user.phone)) return alert("Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ø¨Ù„Ø§Øº ØºÙŠØ± Ø®Ø§Øµ Ø¨Ùƒ");
            const pin = prompt("Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² PIN Ù„Ù„Ø­Ø°Ù:");
            if (String(item.pin) === String(pin)) {
                if(confirm("Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ")) db.ref('reports').child(id).remove().then(() => location.reload());
            } else alert("Ø±Ù…Ø² PIN Ø®Ø§Ø·Ø¦");
        }

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…Ø·ÙˆØ± ---
        function startChat(reportId) {
            const item = allReports.find(r => r.id === reportId);
            const user = JSON.parse(localStorage.getItem('sudan_user_data'));
            if (user.phone === item.phone) return alert("Ù‡Ø°Ø§ Ø¨Ù„Ø§ØºÙƒ Ø§Ù„Ø®Ø§Øµ");
            const roomId = `chat_${reportId}_${item.phone}_${user.phone}`;
            openChatBox(roomId, item.title);
        }

        function openChatBox(roomId, title) {
            const user = JSON.parse(localStorage.getItem('sudan_user_data'));
            document.getElementById('chat-with-name').innerText = title;
            navigate('pg-chat-view');

            document.getElementById('send-btn').onclick = () => {
                const text = document.getElementById('chat-input').value.trim();
                if (!text) return;
                db.ref('chats/' + roomId).push({ sender: user.phone, senderName: user.name, text, timestamp: Date.now() });
                document.getElementById('chat-input').value = "";
            };

            if (currentChatRef) currentChatRef.off();
            currentChatRef = db.ref('chats/' + roomId);
            currentChatRef.on('value', (snap) => {
                let html = "";
                snap.forEach(child => {
                    const m = child.val();
                    html += `<div class="msg ${m.sender === user.phone ? 'me' : 'them'}"><small style="display:block;font-size:9px;opacity:0.6">${m.senderName}</small>${m.text}</div>`;
                });
                const box = document.getElementById('chat-messages');
                box.innerHTML = html; box.scrollTop = box.scrollHeight;
            });
        }

        function loadMyInbox() {
            const user = JSON.parse(localStorage.getItem('sudan_user_data'));
            db.ref('chats').once('value', (snap) => {
                let html = ""; let found = false;
                snap.forEach(room => {
                    if (room.key.includes(user.phone)) {
                        found = true;
                        const last = Object.values(room.val()).pop();
                        html += `<div class="report-card" onclick="openChatBox('${room.key}', 'Ø±Ø¯ Ø¹Ù„Ù‰ Ø¨Ù„Ø§Øº')">
                                    <div style="flex:1"><h4>${last.senderName}</h4><p>${last.text}</p></div>
                                 </div>`;
                    }
                });
                document.getElementById('list-title').innerText = "ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„";
                document.getElementById('my-reports-list').innerHTML = html || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„";
                navigate('pg-my-reports');
            });
        }

        // --- Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ---
        function filterFeed(val) {
            const term = val.toLowerCase().trim();
            const filtered = allReports.filter(r => (r.title && r.title.toLowerCase().includes(term)) || (r.desc && r.desc.toLowerCase().includes(term)));
            renderFeed(filtered);
        }

        function updateStats() {
            db.ref('reports').once('value', (snap) => {
                let l = 0, f = 0;
                snap.forEach(c => { if(c.val().type === 'lost') l++; else f++; });
                document.getElementById('stat-lost-count').innerText = l;
                document.getElementById('stat-found-count').innerText = f;
            });
        }

        function showMyReports() {
            const user = JSON.parse(localStorage.getItem('sudan_user_data'));
            const myData = allReports.filter(r => r.phone === user.phone);
            let html = "";
            myData.forEach(item => { html += `<div class="report-card" onclick="viewDetails('${item.id}')"><img src="${item.img}"><div><h4>${item.title}</h4></div></div>`; });
            document.getElementById('list-title').innerText = "Ø¨Ù„Ø§ØºØ§ØªÙŠ Ø§Ù„Ø´Ø®ØµÙŠØ©";
            document.getElementById('my-reports-list').innerHTML = html || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù„Ø§ØºØ§Øª";
            navigate('pg-my-reports');
        }

        // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ---
        function saveUserData() {
            const name = document.getElementById('user-name-init').value, phone = document.getElementById('user-phone-init').value;
            if(!name || !phone) return alert("Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©");
            localStorage.setItem('sudan_user_data', JSON.stringify({name, phone}));
            document.getElementById('onboarding').style.display = 'none';
            updateProfileUI();
        }

        function updateProfileUI() {
            const user = JSON.parse(localStorage.getItem('sudan_user_data'));
            if(user) { document.querySelectorAll('.u-name').forEach(el => el.innerText = user.name); document.getElementById('u-phone-display').innerText = user.phone; }
        }

        function logout() { if(confirm("Ø®Ø±ÙˆØ¬ØŸ")) { localStorage.clear(); location.reload(); } }
        function openForm(type) { currentType = type; document.getElementById('form-title').innerText = type === 'lost' ? "ÙÙ‚Ø¯Øª Ø´ÙŠØ¦Ø§Ù‹" : "ÙˆØ¬Ø¯Øª Ø´ÙŠØ¦Ø§Ù‹"; navigate('pg-form'); }

        window.onload = () => {
            loadData();
            setTimeout(() => { document.getElementById('splash').style.display = 'none'; }, 2000);
            if(!localStorage.getItem('sudan_user_data')) document.getElementById('onboarding').style.display = 'flex';
            else updateProfileUI();
        };
    </script>
</body>
</html>
