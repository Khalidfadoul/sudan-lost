<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>مفقودات السودان 2026 - النسخة المستقرة</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg: #f2f5f8; --accent: #27ae60; --danger: #e74c3c; --warning: #f1c40f; --text: #2c3e50; --text-dim: #7f8c8d;
            --shadow: 8px 8px 16px #d1d9e6, -8px -8px 16px #ffffff;
            --inner-shadow: inset 6px 6px 12px #d1d9e6, inset -6px -6px 12px #ffffff;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); color: var(--text); margin: 0; direction: rtl; overflow-x: hidden; min-height: 100vh; }
        
        /* الهيكلية الأساسية */
        #main-app { display: none; } /* يظهر فقط بعد التسجيل */
        .page { display: none; padding: 20px 15px 120px; min-height: 100vh; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* العناصر الجمالية */
        .card { background: var(--bg); padding: 20px; border-radius: 25px; box-shadow: var(--shadow); margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.5); }
        .btn-submit { width: 100%; padding: 16px; border-radius: 18px; border: none; background: var(--bg); box-shadow: var(--shadow); color: var(--accent); font-weight: 800; cursor: pointer; margin-top: 12px; font-size: 15px; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.2s; }
        .btn-submit:active { box-shadow: var(--inner-shadow); transform: scale(0.98); }
        
        .report-card { background: var(--bg); padding: 12px; border-radius: 22px; box-shadow: var(--shadow); display: flex; gap: 15px; margin-bottom: 15px; cursor: pointer; align-items: center; }
        .report-card img { width: 85px; height: 85px; border-radius: 18px; object-fit: cover; box-shadow: 2px 2px 5px rgba(0,0,0,0.05); }
        
        .badge { padding: 4px 12px; border-radius: 10px; font-size: 11px; font-weight: bold; }
        .badge-lost { background: #ffdada; color: #c0392b; }
        .badge-found { background: #d4f8e2; color: #27ae60; }

        .notif-dot { position: absolute; top: 10px; right: 25%; width: 10px; height: 10px; background: var(--danger); border-radius: 50%; border: 2px solid var(--bg); display: none; }
        .match-card { background: #fff9e6; border: 2px dashed var(--warning); border-radius: 20px; padding: 15px; margin: 15px 0; cursor: pointer; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        /* التنقل */
        .bottom-nav { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 480px; height: 70px; background: rgba(242, 245, 248, 0.95); backdrop-filter: blur(15px); border-radius: 35px; display: flex; justify-content: space-around; align-items: center; box-shadow: var(--shadow); z-index: 1000; border: 1px solid #fff; }
        .nav-item { color: var(--text-dim); text-align: center; font-size: 10px; flex: 1; cursor: pointer; transition: 0.3s; position: relative; }
        .nav-item.active { color: var(--accent); }
        .plus-center { width: 55px; height: 55px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white !important; margin-top: -40px; border: 4px solid var(--bg); font-size: 22px; box-shadow: 0 8px 15px rgba(39, 174, 96, 0.3); }

        /* الدردشة */
        #chat-messages { height: calc(100vh - 280px); overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 12px 16px; border-radius: 18px; max-width: 85%; font-size: 14px; box-shadow: var(--shadow); line-height: 1.5; }
        .msg.me { align-self: flex-start; background: var(--accent); color: white; border-bottom-right-radius: 4px; }
        .msg.them { align-self: flex-end; background: white; color: var(--text); border-bottom-left-radius: 4px; }

        /* شاشة التحميل والتسجيل */
        #splash { position: fixed; inset: 0; background: var(--bg); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        #onboarding { position: fixed; inset: 0; background: var(--bg); z-index: 9000; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        
        input, textarea { width: 100%; padding: 15px; border-radius: 15px; border: none; box-shadow: var(--inner-shadow); background: var(--bg); margin-bottom: 15px; color: var(--text); outline: none; }
        
        .contact-group { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 15px; }
        .btn-wa { background: #25D366 !important; color: white !important; }
        .btn-call { background: #3498db !important; color: white !important; }
        .btn-chat { background: var(--text) !important; color: white !important; }
    </style>
</head>
<body>

    <div id="splash">
        <i class="fas fa-shield-alt" style="font-size: 60px; color: var(--accent);"></i>
        <h2 style="margin-top: 20px;">مفقودات السودان 2026</h2>
        <div class="loader" style="width: 40px; height: 40px; border: 4px solid #ddd; border-top-color: var(--accent); border-radius: 50%; animation: spin 1s infinite linear;"></div>
    </div>

    <div id="onboarding">
        <div class="card" style="max-width: 400px; width: 100%;">
            <h3 style="text-align:center">التسجيل الرسمي</h3>
            <p style="font-size: 12px; text-align: center; color: var(--text-dim); margin-bottom: 20px;">الرجاء استخدام اسمك الحقيقي ورقم هاتفك لضمان استرداد مفقوداتك.</p>
            <input type="text" id="user-name-init" placeholder="الاسم الرباعي الرسمي">
            <input type="tel" id="user-phone-init" placeholder="رقم الهاتف (مثال: 0912345678)">
            <button class="btn-submit" onclick="saveUserData()">دخول المنصة</button>
        </div>
    </div>

    <main id="main-app">
        <section id="pg-home" class="page active">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div class="card" style="text-align: center; margin-bottom:0"><h2 id="count-lost" style="color:var(--danger); margin:0">0</h2><small>مفقود</small></div>
                <div class="card" style="text-align: center; margin-bottom:0"><h2 id="count-found" style="color:var(--accent); margin:0">0</h2><small>موجود</small></div>
            </div>
            <input type="text" placeholder="بحث باسم الغرض أو المكان..." oninput="filterFeed(this.value)">
            <div id="home-feed"></div>
        </section>

        <section id="pg-details" class="page">
            <div id="details-view"></div>
        </section>

        <section id="pg-profile" class="page">
            <div class="card" style="text-align: center;">
                <h3 id="profile-name-display">..</h3>
                <p id="profile-phone-display" style="color:var(--text-dim);"></p>
                <div style="font-size: 10px; color: var(--accent); border: 1px solid var(--accent); padding: 5px; border-radius: 10px; display:inline-block;">موثق بالهوية</div>
            </div>
            <button class="btn-submit" onclick="showMyReports()"><i class="fas fa-list"></i> إدارة بلاغاتي</button>
            <div class="card" style="margin-top:20px; border-right: 5px solid var(--danger);">
                <h4 style="color:var(--danger); margin:0">تنبيهات أمنية:</h4>
                <ul style="font-size: 12px; padding-right: 20px; line-height: 1.8;">
                    <li>لا تقم بتحويل أموال تحت مسمى "عربون" أو "شحن".</li>
                    <li>المقابلة يجب أن تكون في مكان عام أو قسم شرطة.</li>
                    <li>يتم رصد الـ IP الخاص بك لحماية المجتمع.</li>
                </ul>
            </div>
            <button class="btn-submit" style="color:var(--danger); margin-top:20px;" onclick="logout()">خروج</button>
        </section>

        <section id="pg-form" class="page">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:20px"><i class="fas fa-arrow-right" onclick="navigate('pg-home')"></i> <h2>بلاغ جديد</h2></div>
            <div class="card" style="height:200px; display:flex; align-items:center; justify-content:center; overflow:hidden;" onclick="document.getElementById('file-input').click()">
                <img id="img-preview" style="width:100%; height:100%; object-fit:contain; display:none">
                <div id="upload-placeholder" style="text-align:center;"><i class="fas fa-camera" style="font-size:40px; color: var(--accent)"></i><br>صورة الغرض</div>
                <input type="file" id="file-input" hidden accept="image/*" onchange="handleImageSelection(event)">
            </div>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <button id="type-lost" onclick="setFormType('lost')" class="btn-submit" style="margin:0; background:var(--danger); color:white;">مفقود</button>
                <button id="type-found" onclick="setFormType('found')" class="btn-submit" style="margin:0;">موجود</button>
            </div>
            <input type="text" id="inp-title" placeholder="ماذا فقدت؟ (مثال: تويوتا كورولا)">
            <textarea id="inp-desc" placeholder="وصف مفصل، مكان الفقد، رقم الشاسي إن وجد..."></textarea>
            <input type="number" id="inp-pin" placeholder="PIN للحذف (4 أرقام)">
            <button class="btn-submit" style="background:var(--accent); color:white;" onclick="publishReport()">نشر البلاغ</button>
        </section>

        <section id="pg-chat" class="page">
            <div style="display:flex; align-items:center; gap:15px; margin-bottom:15px;">
                <i class="fas fa-arrow-right" onclick="navigate('pg-inbox')"></i>
                <h4 id="chat-title" style="margin:0">دردشة</h4>
            </div>
            <div id="chat-messages" class="card" style="padding:10px; overflow-y:auto;"></div>
            <div style="display:flex; gap:10px;">
                <input type="text" id="chat-input" placeholder="اكتب هنا..." style="margin:0">
                <button onclick="sendMessage()" style="width:60px; border-radius:15px; border:none; background:var(--accent); color:white;"><i class="fas fa-paper-plane"></i></button>
            </div>
        </section>

        <section id="pg-inbox" class="page">
            <h2>المحادثات</h2>
            <div id="inbox-list-container"></div>
        </section>

        <section id="pg-my-list" class="page">
            <h2>بلاغاتي المنشورة</h2>
            <div id="my-list-container"></div>
        </section>

        <nav class="bottom-nav">
            <div class="nav-item active" onclick="navigate('pg-home', this)"><i class="fas fa-home"></i><br>الرئيسية</div>
            <div class="nav-item" onclick="loadMyInbox(this)"><div id="chat-notif" class="notif-dot"></div><i class="fas fa-comments"></i><br>الرسائل</div>
            <div class="nav-item plus-center" onclick="navigate('pg-form')"><i class="fas fa-plus"></i></div>
            <div class="nav-item" onclick="navigate('pg-profile', this)"><i class="fas fa-shield-alt"></i><br>الأمان</div>
        </nav>
    </main>

    <style>@keyframes spin { to { transform: rotate(360deg); } }</style>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCybHxby_BWoisXHKg5PYEzNgRosBvH66Y",
            authDomain: "mafgoodsudan-b76ab.firebaseapp.com",
            databaseURL: "https://mafgoodsudan-b76ab-default-rtdb.firebaseio.com",
            projectId: "mafgoodsudan-b76ab",
            storageBucket: "mafgoodsudan-b76ab.appspot.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let allReports = [];
        let base64Image = "";
        let currentType = 'lost';
        let currentRoomId = null;

        // --- نظام المستخدم المصلح ---
        function saveUserData() {
            const name = document.getElementById('user-name-init').value.trim();
            const phone = document.getElementById('user-phone-init').value.trim();
            if(name.length < 8 || phone.length < 10) return alert("يرجى إدخال اسمك الرباعي ورقم هاتفك بشكل صحيح");
            
            const userData = { name, phone, joined: Date.now() };
            db.ref('users/' + phone).set(userData).then(() => {
                localStorage.setItem('sudan_user_data', JSON.stringify(userData));
                location.reload(); // إعادة التحميل لتنشيط Main App
            });
        }

        function checkUserAuth() {
            const user = localStorage.getItem('sudan_user_data');
            if(!user) {
                document.getElementById('onboarding').style.display = 'flex';
                document.getElementById('main-app').style.display = 'none';
            } else {
                document.getElementById('onboarding').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                const u = JSON.parse(user);
                document.getElementById('profile-name-display').innerText = u.name;
                document.getElementById('profile-phone-display').innerText = u.phone;
                loadData();
            }
            setTimeout(() => { document.getElementById('splash').style.display = 'none'; }, 1500);
        }

        // --- إدارة البيانات ---
        function loadData() {
            db.ref('reports').on('value', (snap) => {
                allReports = [];
                let lost = 0, found = 0;
                snap.forEach(child => { 
                    const data = child.val();
                    allReports.push({ id: child.key, ...data });
                    data.type === 'lost' ? lost++ : found++;
                });
                document.getElementById('count-lost').innerText = lost;
                document.getElementById('count-found').innerText = found;
                renderFeed(allReports.slice().reverse());
            });
        }

        function renderFeed(data) {
            let html = "";
            data.forEach(item => {
                html += `
                <div class="report-card" onclick="viewDetails('${item.id}')">
                    <img src="${item.img}">
                    <div style="flex:1">
                        <h4 style="margin:0 0 5px 0">${item.title}</h4>
                        <span class="badge ${item.type==='lost'?'badge-lost':'badge-found'}">${item.type==='lost'?'مفقود':'موجود'}</span>
                    </div>
                </div>`;
            });
            document.getElementById('home-feed').innerHTML = html || "<p style='text-align:center; padding:20px;'>لا توجد بلاغات حالياً</p>";
        }

        // --- المطابقة الذكية والتفاصيل ---
        function findMatches(report) {
            const opposite = report.type === 'lost' ? 'found' : 'lost';
            const keywords = (report.title + " " + report.desc).toLowerCase().split(/\s+/).filter(w => w.length > 3);
            return allReports.filter(r => {
                if (r.type !== opposite) return false;
                const targetText = (r.title + " " + r.desc).toLowerCase();
                return keywords.filter(k => targetText.includes(k)).length >= 2;
            });
        }

        function viewDetails(id) {
            const item = allReports.find(r => r.id === id);
            const matches = findMatches(item);
            let matchHtml = matches.length > 0 ? `
                <div class="match-card" onclick="viewDetails('${matches[0].id}')">
                    <h4 style="margin:0; color:var(--warning); font-size:12px;"><i class="fas fa-magic"></i> احتمال تطابق! اضغط لعرض: ${matches[0].title}</h4>
                </div>` : "";

            document.getElementById('details-view').innerHTML = `
                <i class="fas fa-arrow-right" onclick="navigate('pg-home')"></i>
                <div class="card" style="padding:0; overflow:hidden; margin-top:15px"><img src="${item.img}" style="width:100%"></div>
                ${matchHtml}
                <div class="card">
                    <span class="badge ${item.type==='lost'?'badge-lost':'badge-found'}">${item.type==='lost'?'مفقود':'موجود'}</span>
                    <h3>${item.title}</h3>
                    <p>${item.desc}</p>
                    <div style="font-size:11px; color:var(--text-dim)">الناشر: ${item.uName}</div>
                </div>
                <div class="contact-group">
                    <button onclick="window.location.href='tel:${item.phone}'" class="btn-submit btn-call"><i class="fas fa-phone"></i> اتصال</button>
                    <button onclick="window.location.href='https://wa.me/249${item.phone.substring(1)}'" class="btn-submit btn-wa"><i class="fab fa-whatsapp"></i> واتساب</button>
                    <button onclick="startChat('${id}')" class="btn-submit btn-chat"><i class="fas fa-comments"></i> دردشة</button>
                </div>
            `;
            navigate('pg-details');
        }

        // --- نظام الدردشة المطور ---
        function startChat(reportId) {
            const item = allReports.find(r => r.id === reportId);
            const user = JSON.parse(localStorage.getItem('sudan_user_data'));
            if(user.phone === item.phone) return alert("هذا بلاغك الخاص");
            
            currentRoomId = "chat_" + [user.phone, item.phone].sort().join("_");
            document.getElementById('chat-title').innerText = item.title;
            navigate('pg-chat');
            
            db.ref('chats/' + currentRoomId).on('value', snap => {
                let h = "";
                snap.forEach(c => {
                    const m = c.val();
                    h += `<div class="msg ${m.s === user.phone ? 'me' : 'them'}">${m.t}</div>`;
                });
                const box = document.getElementById('chat-messages');
                box.innerHTML = h; box.scrollTop = box.scrollHeight;
            });
        }

        function sendMessage() {
            const t = document.getElementById('chat-input').value.trim();
            const user = JSON.parse(localStorage.getItem('sudan_user_data'));
            if(!t || !currentRoomId) return;
            db.ref('chats/' + currentRoomId).push({ s: user.phone, t: t, time: Date.now() });
            document.getElementById('chat-input').value = "";
        }

        function loadMyInbox(el) {
            const user = JSON.parse(localStorage.getItem('sudan_user_data'));
            navigate('pg-inbox', el);
            db.ref('chats').on('value', snap => {
                let h = "";
                snap.forEach(room => {
                    if(room.key.includes(user.phone)) {
                        const last = Object.values(room.val()).pop();
                        h += `<div class="report-card" onclick="openRoom('${room.key}')"><h4>محادثة: ${last.t.substring(0,20)}...</h4></div>`;
                    }
                });
                document.getElementById('inbox-list-container').innerHTML = h || "لا توجد رسائل";
            });
        }

        // --- الوظائف العامة ---
        function handleImageSelection(e) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = 600; canvas.height = (600/img.width)*img.height;
                    canvas.getContext('2d').drawImage(img, 0,0,600,canvas.height);
                    base64Image = canvas.toDataURL('image/jpeg', 0.7);
                    document.getElementById('img-preview').src = base64Image;
                    document.getElementById('img-preview').style.display = 'block';
                    document.getElementById('upload-placeholder').style.display = 'none';
                };
                img.src = ev.target.result;
            };
            reader.readAsDataURL(e.target.files[0]);
        }

        function publishReport() {
            const user = JSON.parse(localStorage.getItem('sudan_user_data'));
            const title = document.getElementById('inp-title').value;
            const desc = document.getElementById('inp-desc').value;
            const pin = document.getElementById('inp-pin').value;
            if(!title || !base64Image || pin.length < 4) return alert("أكمل البيانات والصورة و PIN");
            
            db.ref('reports').push({
                title, desc, phone: user.phone, uName: user.name, pin, img: base64Image, type: currentType, timestamp: Date.now()
            }).then(() => location.reload());
        }

        function navigate(id, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(el) { document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); el.classList.add('active'); }
        }

        function filterFeed(v) {
            const t = v.toLowerCase();
            renderFeed(allReports.filter(r => r.title.toLowerCase().includes(t) || r.desc.toLowerCase().includes(t)));
        }

        function logout() { if(confirm("خروج؟")) { localStorage.clear(); location.reload(); } }

        window.onload = checkUserAuth;
    </script>
</body>
</html>
